<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- Tu CSS (cuando me lo pases lo integramos mejor) -->
  <link rel="stylesheet" href="/static/css/main.css">
</head>

<body>
  <main class="container py-4 py-sm-5">
    <div class="row justify-content-center">
      <div class="col-12 col-sm-10 col-md-7 col-lg-5 col-xl-4">
        <div class="card shadow-sm">
          <div class="card-body p-4 p-sm-4">

            <!-- Encabezado -->
            <div class="d-flex align-items-center gap-3 mb-3">
              <div class="brand-badge">
                <img src="https://lh3.googleusercontent.com/d/1r3VLia9iHTkhhle4ghvhaz2RPC_4-ezg" alt="Logo" class="brand-logo">
              </div>
              <div>
                <h1 class="h5 mb-0">Iniciar sesión</h1>
                <div class="text-muted small">Acceso al sistema</div>
              </div>
            </div>

            <div id="alert" class="alert d-none mb-3" role="alert"></div>

            <form id="loginForm" class="needs-validation" novalidate>
              <div class="mb-3">
                <label class="form-label" for="email">Correo</label>
                <input
                  class="form-control"
                  type="email"
                  id="email"
                  name="email"
                  inputmode="email"
                  autocomplete="email"
                  required
                  placeholder="tu@correo.com"
                >
                <div class="invalid-feedback">Escribe un correo válido.</div>
              </div>

              <div class="mb-2">
                <label class="form-label" for="password">Contraseña</label>

                <div class="input-group">
                  <input
                    class="form-control"
                    type="password"
                    id="password"
                    name="password"
                    autocomplete="current-password"
                    required
                    placeholder="••••••••"
                  >
                  <button class="btn btn-outline-secondary" type="button" id="togglePass" aria-label="Mostrar contraseña">
                    Ver
                  </button>
                  <div class="invalid-feedback">Escribe tu contraseña.</div>
                </div>
              </div>

              <!--<div class="d-flex align-items-center justify-content-between mt-3 mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="" id="remember">
                   <label class="form-check-label" for="remember">Recordarme</label> 
                </div>
                <a class="small link-inst text-decoration-none" href="#" onclick="return false;">¿Olvidaste tu contraseña?</a>
              </div>-->

              <button class="btn btn-inst w-100 text-white d-inline-flex align-items-center justify-content-center gap-2"
                      id="btnLogin"
                      type="submit">
                <span class="spinner-border spinner-border-sm d-none" id="spinner" aria-hidden="true"></span>
                <span id="btnText">Entrar</span>
              </button>

              <p class="text-muted small mt-3 mb-0">
                Tip: si estás en móvil, gira la pantalla para ver mejor algunos formularios.
              </p>
            </form>

          </div>
        </div>

        <div class="text-center small text-muted mt-3">
          © <span id="year"></span> ATI
        </div>
      </div>
    </div>
  </main>

<script>
const API_BASE = '/api';

const alertBox = document.getElementById('alert');
const form = document.getElementById('loginForm');
const btn = document.getElementById('btnLogin');
const spinner = document.getElementById('spinner');
const btnText = document.getElementById('btnText');

function showAlert(type, msg){
  alertBox.className = `alert alert-${type}`;
  alertBox.textContent = msg;
  alertBox.classList.remove('d-none');
}

function setLoading(isLoading){
  btn.disabled = isLoading;
  spinner.classList.toggle('d-none', !isLoading);
  btnText.textContent = isLoading ? 'Ingresando…' : 'Entrar';
}

document.getElementById('togglePass').addEventListener('click', () => {
  const input = document.getElementById('password');
  const isPass = input.type === 'password';
  input.type = isPass ? 'text' : 'password';
  document.getElementById('togglePass').textContent = isPass ? 'Ocultar' : 'Ver';
  input.focus();
});

// ✅ Si ya hay token válido, manda a su vista
(async function redirectIfLogged(){
  const token = localStorage.getItem("token");
  if (!token) return;

  try {
    const r = await fetch("/api/auth/me", {
      headers: { Authorization: "Bearer " + token }
    });
    if (!r.ok) return;

    const data = await r.json();
    const roles = data?.user?.roles || [];
    if (roles.includes("superadmin")) window.location.href = "/dashboard";
    else window.location.href = "/captura";
  } catch {}
})();

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  alertBox.classList.add('d-none');

  if (!form.checkValidity()) {
    form.classList.add('was-validated');
    return;
  }

  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;

  try{
    setLoading(true);

    const res = await fetch(API_BASE + '/auth/login', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ email, password })
    });

    const data = await res.json().catch(()=>({}));
    if(!res.ok) return showAlert('danger', data.error || 'Error de login');

    localStorage.setItem('token', data.token);
    localStorage.setItem('user', JSON.stringify(data.user));

    const roles = data?.user?.roles || [];
    if (roles.includes('superadmin')) window.location.href = '/dashboard';
    else window.location.href = '/captura';

  }catch(err){
    showAlert('danger', err?.message || 'No se pudo conectar con el servidor.');
  }finally{
    setLoading(false);
  }
});

document.getElementById('year').textContent = new Date().getFullYear();
</script>
</body>
</html>