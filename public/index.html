<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Captura Completa - Actores Pol√≠ticos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="/static/css/main.css">
  <style>
    body { visibility: hidden; }
  </style>
</head>

<body>
  <script>
  (async function guardCaptura() {
        const token = localStorage.getItem("token");
        if (!token) return (window.location.href = "/");

        try {
          const r = await fetch("/api/auth/me", {
            headers: { Authorization: "Bearer " + token }
          });

          if (r.status === 401) {
            localStorage.removeItem("token");
            localStorage.removeItem("user");
            return (window.location.href = "/");
          }

          const data = await r.json();
          const user = data?.user || {};
          const roles = user.roles || [];

          // En captura permites capturista/analista; superadmin al dashboard
          if (roles.includes("superadmin")) return (window.location.href = "/dashboard");
          const ok = roles.includes("capturista") || roles.includes("analista");
          if (!ok) return (window.location.href = "/");

          // Cachea user para UI si quieres (lblUsuario/lblRol)
          localStorage.setItem("user", JSON.stringify(user));
          document.body.style.visibility = "visible";
        } catch (e) {
          localStorage.removeItem("token");
          localStorage.removeItem("user");
          window.location.href = "/";
        }
      })();
  </script>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
  <div class="container-fluid">

    <span class="navbar-brand fw-semibold">
      Actores Pol√≠ticos
    </span>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="topNav">
      <div class="ms-auto d-flex flex-column flex-lg-row align-items-lg-center gap-3 mt-3 mt-lg-0">
        <div class="text-lg-end">
          <div class="fw-semibold text-white" id="lblUsuario">Usuario</div>
          <div class="small text-white-50" id="lblRol">Rol</div>
        </div>

        <button type="button" class="btn btn-outline-danger btn-sm" id="btnLogout">
          Salir
        </button>
      </div>
    </div>

  </div>
</nav>


<div class="container my-4">
  <div id="alertBox" class="alert d-none" role="alert"></div>

  <div class="row g-4">
    <div class="col-12 col-lg-10 mx-auto">
      <div class="card mb-4">
        <div class="card-body">
          <div class="d-flex flex-wrap gap-2 align-items-end">
            <div style="min-width:320px; flex:1;">
              <label class="form-label">Mis borradores</label>
              <select class="form-select" id="selBorradores">
                <option value="">(Cargar borrador...)</option>
              </select>
              <div class="small text-muted mt-1" id="lblBorradorActual">Borrador actual: ninguno</div>
            </div>

            <button type="button" class="btn btn-outline-primary" id="btnGuardarBorrador">
              Guardar borrador
            </button>

            <button type="button" class="btn btn-outline-secondary" id="btnRecargarBorradores">
              Recargar lista
            </button>

            <button type="button" class="btn btn-outline-danger" id="btnEliminarBorrador" disabled>
              Eliminar borrador
            </button>

            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="offcanvas" data-bs-target="#offcanvasPersonas">
              üìã Editar / Eliminar
            </button>
          </div>
        </div>
      </div>
      <form id="personaForm">
      <!-- ================== PERSONA ================== -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="mb-3 card-header-custom">Informaci√≥n personal</h5> <!-- Clase de tu preferencia para Montserrat/blanco [cite:5] -->

          <div class="row g-3">
            <!-- FOTO A LA IZQUIERDA - Nueva columna dedicada -->
            <div class="col-md-3">
              <label class="form-label">Foto</label>
              <input class="form-control" type="file" id="inpFoto" accept="image/*">
              <div class="form-text">JPG/PNG/WebP, m√°ximo 3MB.</div>
              <img id="previewFoto" class="img-thumbnail d-none mt-2" style="max-height:180px; width:150px;">
              <input type="hidden" name="foto_url" id="foto_url">
            </div>

            <!-- CAMPOS PERSONALES - Resto del espacio -->
            <div class="col-md-9">
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label required">Nombre(s)</label>
                  <input class="form-control" name="nombre" required placeholder="Ej. Juan Carlos">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Apellido paterno</label>
                  <input class="form-control" name="apellido_paterno">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Apellido materno</label>
                  <input class="form-control" name="apellido_materno">
                </div>

                <div class="col-md-4">
                  <label class="form-label">CURP</label>
                  <input class="form-control" name="curp" maxlength="18">
                </div>
                <div class="col-md-4">
                  <label class="form-label">RFC</label>
                  <input class="form-control" name="rfc" maxlength="13">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Clave de elector</label>
                  <input class="form-control" name="clave_elector" maxlength="20">
                </div>

                <div class="col-md-6">
                  <label class="form-label">Estado civil</label>
                  <select class="form-select" name="estado_civil">
                    <option value="">Seleccione</option>
                    <option value="Soltero">Soltero</option>
                    <option value="Casado">Casado</option>
                    <option value="Divorciado">Divorciado</option>
                    <option value="Viudo">Viudo</option>
                    <option value="Concubinato">Concubinato</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Nivel de alcance territorial</label>
                  <select class="form-select" name="escala_influencia">
                    <option value="">Seleccione</option>
                    <option value="municipal">Municipal</option>
                    <option value="regional">Regional</option>
                    <option value="distrital">Distrital</option>
                    <option value="estatal">Estatal</option>
                    <option value="nacional">Nacional</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- SEPARADOR -->
          <hr class="my-4">

          <!-- ================== FAMILIARES EN POLITICA ================== -->
          <!-- Ahora correctamente posicionado DENTRO del card principal -->
          <div class="card shadow-sm mb-0"> <!-- mb-0 para no duplicar margen -->
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0"><i class="bi bi-people me-2"></i>Familiares en pol√≠tica / administraci√≥n p√∫blica</h6>
                <button type="button" class="btn btn-outline-primary btn-sm" id="btnAddFamiliar">
                  <i class="bi bi-plus-circle me-1"></i>+ Agregar
                </button>
              </div>
              <div id="familiaresContainer"></div>
            </div>
          </div>
        </div>
      </div>

        <!-- ================== MUNICIPIOS ================== -->
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="mb-3">Municipios</h5>

            <div class="row g-3">

              <!-- Residencia legal -->
              <div class="col-12 col-md-4">
                <label class="form-label">Residencia legal</label>
                <select class="form-select" name="municipio_residencia_legal" id="mun_legal"></select>
              </div>

              <!-- Residencia real -->
              <div class="col-12 col-md-4">
                <label class="form-label">Residencia real</label>
                <select class="form-select" name="municipio_residencia_real" id="mun_real"></select>

                <div class="form-check mt-1">
                  <input class="form-check-input" type="checkbox" id="chkMunRealIgual">
                  <label class="form-check-label small" for="chkMunRealIgual">
                    Igual que residencia legal
                  </label>
                </div>
              </div>

              <!-- Trabajo pol√≠tico -->
              <div class="col-12 col-md-4">
                <label class="form-label">Trabajo pol√≠tico</label>
                <select class="form-select" name="municipio_trabajo_politico" id="mun_trabajo"></select>

                <div class="form-check mt-1">
                  <input class="form-check-input" type="checkbox" id="chkMunTrabajoIgual">
                  <label class="form-check-label small" for="chkMunTrabajoIgual">
                    Igual que residencia legal
                  </label>
                </div>
              </div>
              <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label">Secci√≥n electoral</label>
                    <input class="form-control" name="ine_seccion" maxlength="4" placeholder="Ej. 1234">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Distrito federal</label>
                    <input class="form-control" name="ine_df" maxlength="2" placeholder="Ej. 05">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Distrito local</label>
                    <input class="form-control" name="ine_dl" maxlength="2" placeholder="Ej. 12">
                  </div>
              </div>
            </div>
          </div>
        </div>
        <!-- ================== FORMACION ACADEMICA ================== -->
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="mb-3">Formaci√≥n acad√©mica</h5>

            <div class="row g-3">
              <div class="col-12 col-md-4">
                <label class="form-label">Nivel</label>
                <select class="form-select" id="fa_nivel" name="fa_nivel">
                  <option value="">Seleccione</option>
                  <option value="Primaria">Primaria</option>
                  <option value="Secundaria">Secundaria</option>
                  <option value="Educaci√≥n Media Superior">Educaci√≥n Media Superior</option>
                  <option value="Educaci√≥n Superior">Educaci√≥n Superior</option>
                  <option value="Posgrado">Posgrado</option>
                </select>
              </div>

              <div class="col-12 col-md-4" id="fa_grado_wrap" style="display:none;">
                <label class="form-label">Grado obtenido</label>
                <input class="form-control" id="fa_grado_obtenido" name="fa_grado_obtenido" placeholder="Ej. Licenciatura en Derecho">
                <div class="invalid-feedback">Requerido para Educaci√≥n Superior o Posgrado.</div>
              </div>

              <div class="col-12 col-md-4" id="fa_inst_wrap" style="display:none;">
                <label class="form-label">Instituci√≥n</label>
                <input class="form-control" id="fa_institucion" name="fa_institucion" placeholder="Ej. UAEM">
                <div class="invalid-feedback">Requerido para Educaci√≥n Superior o Posgrado.</div>
              </div>

              <div class="col-12 col-md-4 d-none" id="faTituladoWrap">
                <label class="form-label">Titulado</label>
                <select class="form-select" id="fa_titulado" name="fa_titulado">
                  <option value="">Seleccione</option>
                  <option value="true">S√≠</option>
                  <option value="false">No</option>
                </select>
              </div>

            </div>

            <div class="small text-muted mt-2">
              *Si seleccionas Educaci√≥n Superior o Posgrado, se habilitan ‚ÄúGrado obtenido‚Äù e ‚ÄúInstituci√≥n‚Äù.
            </div>
          </div>
        </div>
        <!-- ================== TELEFONOS ================== -->
        <div class="card mb-4">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">Tel√©fonos</h5>
              <button type="button" class="btn btn-outline-primary btn-sm" id="btnAddTelefono">+ Agregar</button>
            </div>
            <div class="small-muted mb-3">Recomendado: solo uno marcado como <b>principal</b>.</div>
            <div id="telefonosContainer"></div>
          </div>
        </div>

        <!-- ================== PAREJAS ================== -->
        <div class="card mb-4">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">Parejas</h5>
              <button type="button" class="btn btn-outline-primary btn-sm" id="btnAddPareja">+ Agregar</button>
            </div>
            <div class="small-muted mb-3">Tipo relaci√≥n: <code>actual</code> o <code>anterior</code>.</div>
            <div id="parejasContainer"></div>
          </div>
        </div>

        <!-- ================== HIJOS ================== -->
        <div class="card mb-4">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">Hijos</h5>
              <button type="button" class="btn btn-outline-primary btn-sm" id="btnAddHijo">+ Agregar</button>
            </div>
            <div id="hijosContainer"></div>
          </div>
        </div>

        <!-- ================== REDES ================== -->
        <div class="card mb-4">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">Redes sociales</h5>
              <button type="button" class="btn btn-outline-primary btn-sm" id="btnAddRed">+ Agregar</button>
            </div>
            <div id="redesContainer"></div>
          </div>
        </div>

        <!-- ================== TRAYECTORIA POL√çTICA ================== -->
        <div class="card mb-4">
          <div class="card-body">
            <!-- ===== ELECCI√ìN POPULAR ===== -->
            <div class="mb-4">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Cargos de elecci√≥n popular</h5>
                <div class="form-check mb-0">
                  <input class="form-check-input" type="checkbox" id="chkSinCargosEleccion">
                  <label class="form-check-label" for="chkSinCargosEleccion">
                    No ha ocupado cargos de elecci√≥n popular
                  </label>
                </div>
              </div>

              <div id="cargosEleccionSection">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0">Detalle de cargos</h6>
                  <button type="button" class="btn btn-outline-primary btn-sm" id="btnAddCargoEleccion">
                    + Agregar
                  </button>
                </div>

                <div class="small text-muted mb-2">
                  Indica √∫nicamente cargos obtenidos por elecci√≥n popular.
                </div>

                <div id="cargosEleccionContainer"></div>
              </div>
            </div>

            <hr class="my-4">

            <!-- ===== SERVICIO P√öBLICO ===== -->
            <div class="mb-4">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Servicio P√∫blico</h5>
                <div class="form-check mb-0">
                  <input class="form-check-input" type="checkbox" id="sin_sp" name="sin_servicio_publico">
                  <label class="form-check-label" for="sin_sp">
                    No ha ocupado cargos en el servicio p√∫blico
                  </label>
                </div>
              </div>

              <button type="button" class="btn btn-outline-primary btn-sm" id="btnAddServicio" style="margin-bottom: 1rem;">
                + Agregar
              </button>

              <div id="servicioPublicoSection">
                <div class="small text-muted mb-3">
                  Registra cargos desempe√±ados en la administraci√≥n p√∫blica (no necesariamente de elecci√≥n).
                </div>
                <div id="servicioContainer"></div>
              </div>
            </div>
            <hr class="my-4">
            <!-- ===== EXPERIENCIA LABORAL (FUERA SP) ===== -->
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">Experiencia laboral relevante (fuera del servicio p√∫blico)</h5>
              <button type="button" class="btn btn-outline-primary btn-sm" id="btnAddExpLab">
                + Agregar
              </button>
            </div>

            <div class="small text-muted mb-3">
              Incluye empleos o cargos relevantes en empresas, organizaciones, asociaciones, etc.
            </div>

            <div id="expLabContainer"></div>
          </div>
        </div>

 
        <!-- ================== MILITANCIA E IDEOLOG√çA / TRABAJO POL√çTICO ================== -->
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="mb-3">Militancia e ideolog√≠a / Trabajo pol√≠tico</h5>

            <div class="row g-3">
            <div class="col-12 col-md-4">
              <label class="form-label">Ideolog√≠a pol√≠tica</label>
              <select class="form-select" id="selIdeologia" name="id_ideologia_politica">
                <option value="">Seleccione</option>
              </select>
            </div>
              <!-- Partido actual -->
              <div class="col-12 col-md-4">
                <label class="form-label">Partido pol√≠tico actual</label>
                <select class="form-select" id="selPartidoActual" name="id_partido_actual">
                  <option value="">Seleccione</option>
                </select>

                <div class="mt-2 d-none" id="partidoOtroWrap">
                  <label class="form-label">Especifique partido</label>
                  <input
                    class="form-control"
                    id="partidoOtroTexto"
                    name="partido_otro_texto"
                    placeholder="Captura el nombre del partido"
                  >
                  <div class="form-text">Solo aplica si seleccionas ‚ÄúOtro‚Äù.</div>
                </div>
              </div>

              <!-- Tema(s) de inter√©s pol√≠tico central -->
              <div class="col-12">
                <label class="form-label">Tema(s) de inter√©s pol√≠tico central</label>
                <div id="temasInteresChecks" class="border rounded p-2 bg-light" style="max-height: 180px; overflow:auto;">
                  <div class="text-muted small">Cargando temas‚Ä¶</div>
                </div>
                <!-- ‚ÄúOtro‚Äù -->
                <div class="mt-2 d-none" id="temaOtroWrap">
                  <label class="form-label">Especifique ‚ÄúOtro‚Äù</label>
                  <input class="form-control" id="temaOtroTexto" placeholder="Captura el tema">
                  <div class="form-text">Solo aplica si seleccionas ‚ÄúOtro‚Äù.</div>
                </div>
              </div>

              <!-- Grupo postulaci√≥n (single) -->
              <div class="col-12 col-md-4">
                <label class="form-label">Accion afirmativa aplicable</label>
                <select class="form-select" id="selGrupoPostulacion" name="id_grupo_postulacion">
                  <option value="">Seleccione</option>
                </select>
              </div>

              <!-- ‚ÄúOtro‚Äù tema -->
              <div class="col-12 d-none" id="temaOtroWrap">
                <label class="form-label">Especifique ‚ÄúOtro‚Äù</label>
                <input class="form-control" id="temaOtroTexto" name="tema_interes_otro_texto"
                      placeholder="Describe el tema de inter√©s">
                <div class="invalid-feedback">Este campo es obligatorio cuando seleccionas ‚ÄúOtro‚Äù.</div>
              </div>
            </div>

            <hr class="my-4">

            <!-- Participaci√≥n en otros partidos / organizaciones -->
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-2">
              <h6 class="mb-0">Antecedentes de Participaci√≥n en otros partidos u organizaciones</h6>
              <button type="button" class="btn btn-outline-primary btn-sm" id="btnAddParticipacion">+ Agregar</button>
            </div>
            <div id="participacionContainer"></div>
          </div>
        </div>

        <!-- ================== EFECTIVIDAD ELECTORAL ================== -->
        <div class="card mb-4">
          <div class="card-body">

            <div class="row g-3 align-items-end mb-3">
              <div class="col-12 col-md-4">
                <label class="form-label">¬øParticip√≥ en la contienda electoral?</label>
                <select class="form-select" name="ha_contendido_eleccion" id="selHaContendido">
                  <option value="">Seleccione...</option>
                  <option value="true">S√≠</option>
                  <option value="false">No</option>
                </select>
              </div>
            </div>

            <!-- ‚úÖ SOLO SE MUESTRA SI RESPUESTA = S√ç -->
            <div id="eleccionesWrap">
              <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2 mb-3">
                <div>
                  <h5 class="mb-0">Efectividad electoral</h5>
                  <div class="text-muted small">Elecciones contendidas</div>
                </div>

                <button type="button" class="btn btn-outline-primary btn-sm" id="btnAddEleccion">
                  + Agregar elecci√≥n
                </button>
              </div>

              <div id="eleccionesContainer" class="mb-3"></div>

              <hr class="my-3">
            </div>

            <div class="row g-3">
              <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2 mb-2">
                <div>
                  <h6 class="mb-0">Eventos de movilizaci√≥n</h6>
                  <div class="text-muted small">Nombre, fecha y asistencia por evento</div>
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm" id="btnAddMovEvento">
                  + Agregar evento
                </button>
              </div>

              <div id="movEventosContainer"></div>
            </div>

          </div>
        </div>


        <!-- ================== EQUIPOS Y REFERENTES ================== -->
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="mb-3">Equipo<code> (Opcional)</code> y referentes pol√≠ticos</h5>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Equipos pol√≠ticos</h6>
              <button type="button" class="btn btn-outline-primary btn-sm" id="btnAddEquipo">+ Agregar</button>
            </div>
            <div id="equiposContainer" class="mb-3"></div>

            <hr class="my-3">

            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Referentes pol√≠ticos</h6>
              <button type="button" class="btn btn-outline-primary btn-sm" id="btnAddReferente">+ Agregar</button>
            </div>
            <div id="referentesContainer"></div>
          </div>
        </div>

<!-- ================== CONTROVERSIAS ================== -->
      <div class="card mb-4">
        <div class="card-body">
          <!-- Header + bot√≥n (responsive) -->
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-2">
            <h5 class="mb-0">Controversias</h5>
            <button type="button" class="btn btn-outline-primary btn-sm" id="btnAddControversia">
              + Agregar
            </button>
          </div>

          <!-- Checkbox ‚Äúsin controversias‚Äù -->
          <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="chkSinControversias">
              <label class="form-check-label" for="chkSinControversias">
                No se detectaron controversias p√∫blicas
              </label>
              <div class="form-text">
                Si activas esta opci√≥n, se deshabilita la captura de controversias.
              </div>
            </div>

              <!-- Mensaje cuando est√° activo -->
              <div id="sinControversiasMsg" class="alert alert-success py-2 d-none" role="alert">
                  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                    <div>
                      <strong>Sin controversias p√∫blicas</strong>
                    </div>
                    <span class="badge text-bg-success">Validado</span>
                  </div>
                </div>

                <!-- Contenedor normal -->
                <div id="controversiasContainer"></div>
              </div>
      </div>
        <!-- ================== SUBMIT ================== -->
        <div class="d-flex justify-content-end gap-2 mb-5">
          <button type="button" class="btn btn-outline-secondary" id="btnReset">Limpiar</button>
          <button type="submit" class="btn btn-primary btn-lg">Guardar todo</button>
        </div>

      </form>
    </div>

    <!-- ================== PREVIEW ==================
    <div class="col-lg-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Payload</h5>
          <p class="small-muted">Lo que se enviar√° a <code>POST /api/personas</code>.</p>
          <pre id="payloadPreview" class="bg-light p-3 rounded" style="max-height: 75vh; overflow:auto; font-size: 12px;"></pre>
        </div>
      </div>
    </div> -->

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    //funcion para ocultar efectividad electoral
  function setEleccionesUIState() {
    const sel = document.getElementById('selHaContendido');
    const wrap = document.getElementById('eleccionesWrap');
    if (!sel || !wrap) return;

    const val = sel.value;                 // "true" | "false" | ""
    const showElecciones = (val === 'true');

    wrap.classList.toggle('d-none', !showElecciones);

    // Si es NO, limpiamos elecciones para que no se env√≠en y no confundan
    if (!showElecciones) {
      const cont = document.getElementById('eleccionesContainer');
      if (cont) cont.innerHTML = '';
    }
  }
  
  function logout() {
    localStorage.removeItem("token");
    localStorage.removeItem("user");
    window.location.href = "/";
  }

  document.getElementById("btnLogout")?.addEventListener("click", () => {
    if (confirm("¬øDeseas cerrar sesi√≥n?")) logout();
  });

  // ‚úÖ Validaci√≥n real contra backend
  (async function bootUser() {
    const token = localStorage.getItem("token");
    if (!token) return (window.location.href = "/");

    try {
      const r = await fetch("/api/auth/me", {
        headers: { Authorization: "Bearer " + token },
      });

      if (r.status === 401) return logout();

      const data = await r.json();
      const user = data?.user || {};
      const roles = user.roles || [];

      // ‚úÖ En captura: permites capturista y analista
      // (superadmin lo mandas al dashboard)
      if (roles.includes("superadmin")) {
        return (window.location.href = "/dashboard");
      }
      const ok = roles.includes("capturista") || roles.includes("analista");
      if (!ok) return logout();

      document.getElementById("lblUsuario").textContent =
        user.nombre || user.email || "Usuario";
      document.getElementById("lblRol").textContent = roles.join(", ");

      localStorage.setItem("user", JSON.stringify(user));
    } catch (e) {
      console.error("bootUser error:", e);
      return logout();
    }
  })();

  // ‚úÖ Base relativa (funciona local y Render)
  const API_BASE = "/api";

  // ‚úÖ √önico helper para requests (NO dupliques apiGet/apiPost/etc)
  async function apiFetch(path, opts = {}) {
    const token = localStorage.getItem("token");

    const headers = {
      ...(opts.headers || {}),
      ...(token ? { Authorization: `Bearer ${token}` } : {}),
    };

    const res = await fetch(API_BASE + path, { ...opts, headers });

    if (res.status === 401) {
      logout();
      return null; // por si alguien intenta usarlo despu√©s del redirect
    }

    const text = await res.text();
    let data = {};
    try {
      data = text ? JSON.parse(text) : {};
    } catch {
      data = { raw: text };
    }

    if (!res.ok) {
      const msg = data?.error || data?.message || text || "Error";
      throw new Error(msg);
    }

    return data;
  }

  const apiGet = (path) => apiFetch(path);

  const apiPost = (path, body) =>
    apiFetch(path, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });

  const apiPut = (path, body) =>
    apiFetch(path, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });

  const apiDelete = (path) =>
    apiFetch(path, {
      method: "DELETE",
    });

  const $ = (sel) => document.querySelector(sel);



  let municipiosCache = [];
  let redesCatalog = [];
  let controversiasCatalog = [];
  let borradorActualId = null;
  let temasCatalog = [];
  let editingId = null;
  let fotoUrlActual = null;

  function showAlert(type, msg) {
    const box = $('#alertBox');
    box.className = `alert alert-${type}`;
    box.textContent = msg;
    box.classList.remove('d-none');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
  function hideAlert(){ $('#alertBox').classList.add('d-none'); }


    function getMunicipioNombreById(id) {
    const n = Number(id);
    const m = (municipiosCache || []).find(x => Number(x.id_municipio) === n);
    return m?.nombre || null;
  }

  //editar persona cargar datos
    function cancelEditing() {
        // deja tu estado de edici√≥n limpio
        editingId = null;
  
        // deshabilita botones
        const btnSalir = document.getElementById('btnSalirEdicion');
        const btnEliminar = document.getElementById('btnEliminarPersona');
        if (btnSalir) btnSalir.disabled = true;
        if (btnEliminar) btnEliminar.disabled = true;
  
        // opcional: reset del submit
        const btnSubmit = document.getElementById('btnSubmitPersona');
        if (btnSubmit) btnSubmit.textContent = 'Guardar';
  
        // limpia formulario
        if (typeof clearAll === 'function') clearAll();
        if (typeof refreshPreview === 'function') refreshPreview();
      }
    async function onEditPersona(id_persona) {
    try {
      const payload = await apiGet(`/personas/${id_persona}/payload`);
      applyPayloadToForm(payload);     // üëà tu funci√≥n actual
      setEditing(id_persona);          // üëà activa modo edici√≥n
      showAlert("info", `Editando registro #${id_persona}`);
    } catch (e) {
      console.error(e);
      showAlert("danger", "No pude cargar el registro para editar: " + e.message);
    }
  }
  //detele
  async function onDeletePersona(id_persona) {
    const ok = confirm(`¬øEliminar el registro #${id_persona}? Esta acci√≥n no se puede deshacer.`);
    if (!ok) return;
  
    try {
      await apiDelete(`/personas/${id_persona}`);
      showAlert("success", `Eliminado ‚úÖ (#${id_persona})`);
  
      // si justo estabas editando ese registro
      if (editingId === Number(id_persona)) cancelEditing();
  
      if (typeof reloadPanelPersonas === "function") await reloadPanelPersonas();
    } catch (e) {
      console.error(e);
      showAlert("danger", "No pude eliminar: " + e.message);
    }
  }

  function generarTituloBorrador(payload) {
    const nombre = payload?.persona?.nombre?.trim() || 'SIN NOMBRE';
    const munId = payload?.persona?.municipio_trabajo_politico;
    const munNombre = munId ? (getMunicipioNombreById(munId) || `Municipio ${munId}`) : 'SIN MUNICIPIO';
    return `${nombre} - ${munNombre}`;
  }

  async function cargarListaBorradores() {
    const sel = document.getElementById('selBorradores');
    sel.innerHTML = `<option value="">(Cargar borrador...)</option>`;

    const borradores = await apiGet('/borradores/mios');
    borradores.forEach(b => {
      const opt = document.createElement('option');
      opt.value = b.id_borrador;
      const fecha = (b.updated_at || b.created_at || '').toString().slice(0, 19).replace('T',' ');
      opt.textContent = `${b.titulo || '(sin t√≠tulo)'}  ‚Äî  ${b.estatus}  ‚Äî  ${fecha}`;
      sel.appendChild(opt);
    });
  }

  function setBorradorActual(id) {
    borradorActualId = id ? Number(id) : null;
    const lbl = document.getElementById('lblBorradorActual');
    const btnDel = document.getElementById('btnEliminarBorrador');

    if (!borradorActualId) {
      lbl.textContent = 'Borrador actual: ninguno';
      btnDel.disabled = true;
    } else {
      lbl.textContent = `Borrador actual: #${borradorActualId}`;
      btnDel.disabled = false;
    }
  }

  // Aplica el payload al formulario (rellena todo)
  function applyPayloadToForm(payload) {
    clearAll(); // limpia y deja 1 bloque de cada cosa (seg√∫n tu implementaci√≥n)

    // 1) persona
    const p = payload.persona || {};
    const setVal = (name, value) => {
      const el = document.querySelector(`[name="${name}"]`);
      if (!el) return;
      el.value = (value ?? '') === null ? '' : String(value ?? '');
    };

    setVal('nombre', p.nombre);
    setVal('apellido_paterno', p.apellido_paterno);
    setVal('apellido_materno', p.apellido_materno);
    setVal('curp', p.curp);
    setVal('rfc', p.rfc);
    setVal('clave_elector', p.clave_elector);
    setVal('estado_civil', p.estado_civil);
    setVal('escala_influencia', p.escala_influencia);
    setVal('ha_contendido_eleccion', p.ha_contendido_eleccion === null ? '' : String(p.ha_contendido_eleccion));
    document.getElementById('sin_sp').checked = !!p.sin_servicio_publico;

    setVal('municipio_residencia_legal', p.municipio_residencia_legal);
    setVal('municipio_residencia_real', p.municipio_residencia_real);
    setVal('municipio_trabajo_politico', p.municipio_trabajo_politico);

    // 2) datos_ine
    const ine = payload.datos_ine || {};
    setVal('ine_seccion', ine.seccion_electoral);
    setVal('ine_df', ine.distrito_federal);
    setVal('ine_dl', ine.distrito_local);

    // Helpers para reconstruir listas
    document.getElementById('chkSinControversias').checked =
      payload?.persona?.sin_controversias_publicas === true;

    // aplica estado UI (deshabilita bot√≥n y limpia si est√° activo)
    const rebuildList = (containerId, items, createBlock, fillFn) => {
      const c = document.getElementById(containerId);
      c.innerHTML = '';
      (items || []).forEach(it => {
        const b = createBlock();
        c.appendChild(b);
        fillFn(b, it);
      });
      // si estaba vac√≠o, deja uno
      if ((items || []).length === 0) c.appendChild(createBlock());
    };

    // 3) parejas (ya migrado a periodo)
    rebuildList('parejasContainer', payload.parejas || [], parejaBlock, (b, it) => {
      if (it.temp_id) b.dataset.tempId = it.temp_id;

      b.querySelector('input[name="nombre_pareja"]').value = it.nombre_pareja || '';
      b.querySelector('select[name="tipo_relacion"]').value = it.tipo_relacion || '';

      const inpPeriodo = b.querySelector('input[name="periodo"]');
      if (inpPeriodo) inpPeriodo.value = it.periodo || '';
    });

    // refresca selects de hijos con parejas cargadas
    refreshHijosParejasSelects();

    // 4) hijos
    rebuildList('hijosContainer', payload.hijos || [], hijoBlock, (b, it) => {
      b.querySelector('input[name="anio_nacimiento"]').value = it.anio_nacimiento || '';
      b.querySelector('select[name="sexo"]').value = it.sexo || '';
      const sel = b.querySelector('select[name="pareja_temp_id"]');
      fillHijoParejaSelect(sel);
      sel.value = it.pareja_temp_id || '';
    });

    // 5) telefonos
    rebuildList('telefonosContainer', payload.telefonos || [], telefonoBlock, (b, it) => {
      b.querySelector('input[name="telefono"]').value = it.telefono || '';
      b.querySelector('select[name="tipo"]').value = it.tipo || '';
      b.querySelector('input[name="principal"]').checked = !!it.principal;
    });

    // 6) redes
    rebuildList('redesContainer', payload.redes || [], redBlock, (b, it) => {
      b.querySelector('select[name="id_red"]').value = it.id_red || '';
      b.querySelector('input[name="url"]').value = it.url || '';
    });

    // 7) servicio_publico
    rebuildList('servicioContainer', payload.servicio_publico || [], servicioBlock, (b, it) => {
      b.querySelector('input[name="periodo"]').value = it.periodo || '';
      b.querySelector('input[name="cargo"]').value = it.cargo || '';
      b.querySelector('input[name="dependencia"]').value = it.dependencia || '';
    });

    // 8) elecciones
    // ===== EFECTIVIDAD ELECTORAL (Elecciones contendidas) =====

    // 1) Setear el select desde persona
    const selHa = document.getElementById('selHaContendido');
    if (selHa) {
      selHa.value =
        p.ha_contendido_eleccion === null || p.ha_contendido_eleccion === undefined
          ? ''
          : String(!!p.ha_contendido_eleccion);
    }

    // üîπ BONUS: si hay elecciones pero el campo vino null, forzamos "S√≠"
    const tieneElecciones = (payload.elecciones || []).length > 0;
    if (selHa && tieneElecciones && !selHa.value) {
      selHa.value = 'true';
    }

    // 2) Aplicar UI (mostrar/ocultar wrapper)
    // ‚ö†Ô∏è ESTO LIMPIA EL CONTENEDOR SI ES "NO"
    setEleccionesUIState();

    // 3) SOLO si est√° visible, reconstruimos elecciones
    if (selHa && selHa.value === 'true') {
      rebuildList('eleccionesContainer', payload.elecciones || [], eleccionBlock, (b, it) => {
        b.querySelector('input[name="anio_eleccion"]').value = it.anio_eleccion || '';
        b.querySelector('input[name="candidatura"]').value = it.candidatura || '';
        b.querySelector('input[name="partido_postulacion"]').value = it.partido_postulacion || '';
        b.querySelector('select[name="resultado"]').value = it.resultado || '';
        b.querySelector('input[name="diferencia_votos"]').value = it.diferencia_votos || '';
        b.querySelector('input[name="diferencia_porcentaje"]').value = it.diferencia_porcentaje || '';
      });
    }

    // 10) equipos
    rebuildList('equiposContainer', payload.equipos || [], equipoBlock, (b, it) => {
      b.querySelector('input[name="nombre_equipo"]').value = it.nombre_equipo || '';
      b.querySelector('select[name="activo"]').value = String(it.activo ?? true);
    });

    // 11) referentes (ya migrado a nombres/apellidos)
    rebuildList('referentesContainer', payload.referentes || [], referenteBlock, (b, it) => {
      b.querySelector('select[name="nivel"]').value = it.nivel || '';

      const n = b.querySelector('input[name="nombres"]');
      const ap = b.querySelector('input[name="apellido_paterno"]');
      const am = b.querySelector('input[name="apellido_materno"]');

      if (n)  n.value  = it.nombres || '';
      if (ap) ap.value = it.apellido_paterno || '';
      if (am) am.value = it.apellido_materno || '';
    });

    // 12) controversias
    if (!document.getElementById('chkSinControversias').checked) {
      rebuildList('controversiasContainer', payload.controversias || [], controversiaBlock, (b, it) => {
        b.querySelector('select[name="id_tipo"]').value = it.id_tipo || '';
        b.querySelector('input[name="fecha_registro"]').value = it.fecha_registro || '';
        b.querySelector('textarea[name="descripcion"]').value = it.descripcion || '';
        b.querySelector('input[name="fuente"]').value = it.fuente || '';
      });
    }

    // 13) familiares
    rebuildList('familiaresContainer', payload.familiares || [], familiarBlock, (b, it) => {
      b.querySelector('input[name="nombre"]').value = it.nombre || '';
      b.querySelector('input[name="parentesco"]').value = it.parentesco || '';
      b.querySelector('input[name="cargo"]').value = it.cargo || '';
      b.querySelector('input[name="institucion"]').value = it.institucion || '';
    });

    //14 ELECCION POPULAR
    const chkSinCargos = document.getElementById('chkSinCargosEleccion');
    if (chkSinCargos) chkSinCargos.checked = !!p.sin_cargos_eleccion_popular;

    const cargos = payload.cargos_eleccion_popular || [];
    rebuildList('cargosEleccionContainer', cargos, cargoEleccionBlock, (b, it) => {
      b.querySelector('input[name="periodo"]').value = it.periodo || '';
      b.querySelector('input[name="cargo"]').value = it.cargo || '';
      b.querySelector('input[name="partido_postulante"]').value = it.partido_postulante || '';
      b.querySelector('select[name="modalidad"]').value = it.modalidad || '';
    });
    // ‚úÖ Formaci√≥n acad√©mica (single)
    const fa = (payload.formacion_academica || [])[0] || {};

    const selNivel = document.querySelector('[name="fa_nivel"]') || document.getElementById('fa_nivel');
    const inpGrado = document.querySelector('[name="fa_grado_obtenido"]') || document.getElementById('fa_grado_obtenido');
    const inpInst  = document.querySelector('[name="fa_institucion"]') || document.getElementById('fa_institucion');
    const selTit   = document.querySelector('[name="fa_titulado"]') || document.getElementById('fa_titulado');

    // 1) set valores
    if (selNivel) selNivel.value = fa.nivel || '';
    if (inpGrado) inpGrado.value = fa.grado_obtenido || '';
    if (inpInst)  inpInst.value  = fa.institucion || '';
    if (selTit)   selTit.value   = (fa.titulado == null) ? '' : String(!!fa.titulado);

    // 2) FORZAR UI (mostrar/ocultar) igual que cuando el usuario cambia el select
    //    - si tienes una funci√≥n, ll√°mala
    if (typeof toggleFormacionUI === 'function') {
      toggleFormacionUI();
    } else if (selNivel) {
      // si no tienes funci√≥n, fuerza el change para que se ejecute el listener que ya tengas
      selNivel.dispatchEvent(new Event('change', { bubbles: true }));
    }
    //‚úÖ EVENTOS DE MOVILIZACION
    rebuildList('movEventosContainer', payload.capacidad_movilizacion_eventos || [], movEventoBlock, (b, it) => {
      b.querySelector('input[name="mov_nombre_evento"]').value = it.nombre_evento || '';

      const inpFecha = b.querySelector('input[name="mov_fecha_evento"]');
      if (inpFecha) {
        const raw = it.fecha_evento;
        // normaliza: "2026-02-05T..." -> "2026-02-05"
        inpFecha.value = raw ? String(raw).slice(0, 10) : '';
      }

      b.querySelector('input[name="mov_asistencia_evento"]').value = (it.asistencia ?? '');
    });
    //‚úÖ EXPERIENCIA LABORAL
    rebuildList('expLabContainer', payload.experiencia_laboral || [], expLabBlock, (b, it) => {
      b.querySelector('input[name="periodo"]').value = it.periodo || '';
      b.querySelector('input[name="cargo"]').value = it.cargo || '';
      b.querySelector('input[name="organizacion"]').value = it.organizacion || '';
    });

    //SIN SERVICIO PUBLICO
    // Sin servicio p√∫blico (ocultar secci√≥n)
    const chkSP = document.getElementById('sin_sp');
    if (chkSP) chkSP.checked = !!p.sin_servicio_publico;
    if (typeof setSinServicioUI === 'function') setSinServicioUI();

    // aplica toggle si existe
    if (typeof setSinCargosUI === 'function') setSinCargosUI();
    // Foto
    fotoUrlActual = p.foto_url || null;

    setVal('foto_url', fotoUrlActual);

    const img = document.getElementById('previewFoto'); // ‚úÖ mismo id que tu uploader
    if (img) {
      img.src = fotoUrlActual || '';
      img.classList.toggle('d-none', !fotoUrlActual);
    }

    // 1) Partido actual
    const selPartido = document.getElementById('selPartidoActual');
    if (selPartido) {
      selPartido.value = payload?.persona?.id_partido_actual ?? '';
    }

    // 2) Tema inter√©s central
   

    // 3) Texto ‚ÄúOtro‚Äù
    const inpOtro = document.getElementById('temaOtroTexto');
    if (inpOtro) {
      inpOtro.value = payload?.persona?.tema_interes_otro_texto ?? '';
      inpOtro.classList.remove('is-invalid');
    }

    // 4) Grupo postulaci√≥n (single)
    const selGrupo = document.getElementById('selGrupoPostulacion');
    if (selGrupo) {
      selGrupo.value = payload?.persona?.id_grupo_postulacion ?? '';
    }

    // 5) Aplicar toggle de UI para ‚ÄúOtro‚Äù
    // (importante hacerlo despu√©s de setear el select)
    if (typeof toggleTemaOtroUI === 'function') {
      toggleTemaOtroUI();
    }

    // 6) Reconstruir lista participaci√≥n ( + )
    const itemsPO = payload?.participacion_organizaciones || [];
    rebuildList('participacionContainer', itemsPO, participacionBlock, (b, it) => {
      b.querySelector('select[name="po_tipo"]').value = it.tipo || '';
      b.querySelector('input[name="po_nombre"]').value = it.nombre || '';
      b.querySelector('input[name="po_rol"]').value = it.rol || '';
      b.querySelector('input[name="po_periodo"]').value = it.periodo || '';
      b.querySelector('input[name="po_notas"]').value = it.notas || '';
    });
    //7 construir temas interes
    // Temas inter√©s (checkboxes)
    const temas = payload.temas_interes || [];
    // limpiar checks
    document.querySelectorAll('.tema-interes-chk').forEach(chk => chk.checked = false);

    temas.forEach(t => {
      const chk = document.querySelector(`.tema-interes-chk[data-id="${Number(t.id_tema)}"]`);
      if (chk) chk.checked = true;
    });

    // texto de ‚ÄúOtro‚Äù
    const otro = temas.find(t => t.otro_texto);
    document.getElementById('temaOtroTexto').value = otro?.otro_texto || '';

    toggleTemaOtroUI();

    document.getElementById('selIdeologia').value = payload?.persona?.id_ideologia_politica ?? '';

    refreshPreview();
  }

 function fillSelect(el, rows, valueKey, textKey, placeholder = 'Seleccione') {
    if (!el) return; // ‚úÖ evita error si el elemento no existe

    el.innerHTML = `<option value="">${placeholder}</option>`;
    (rows || []).forEach(r => {
      const opt = document.createElement('option');
      opt.value = r[valueKey];
      opt.textContent = r[textKey];
      el.appendChild(opt);
    });
  }

  const toIntOrNull = (v) => (v === '' || v == null) ? null : (Number.isFinite(Number(v)) ? Number(v) : null);
  const toBoolOrNull = (v) => (v === 'true') ? true : (v === 'false') ? false : null;

  // ---------- UI Blocks ----------
  function movEventoBlock() {
    const div = document.createElement('div');
    div.className = 'list-item mb-2';

    div.innerHTML = `
      <div class="row g-2 align-items-end">
        <div class="col-12 col-md-6">
          <label class="form-label">Nombre del evento</label>
          <input class="form-control" name="mov_nombre_evento" placeholder="Ej. Asamblea regional">
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">Fecha</label>
          <input type="date" class="form-control" name="mov_fecha_evento">
        </div>

        <div class="col-12 col-md-2">
          <label class="form-label">Asistencia</label>
          <input type="number" min="0" class="form-control" name="mov_asistencia_evento" inputmode="numeric" placeholder="Ej. 220">
        </div>

        <div class="col-12 col-md-1 text-md-end">
          <button type="button" class="btn btn-outline-danger btn-sm w-100 btnRemove">X</button>
        </div>
      </div>
    `;

    div.querySelector('.btnRemove').addEventListener('click', () => {
      div.remove();
      refreshPreview?.();
    });

    // refrescar preview con input/change en ese bloque
    div.addEventListener('input', () => refreshPreview?.());
    div.addEventListener('change', () => refreshPreview?.());

    return div;
  }


  function telefonoBlock() {
    const div = document.createElement('div');
    div.className = 'list-item';
    div.innerHTML = `
      <div class="row g-2 align-items-end">
        <div class="col-md-5">
          <label class="form-label">Tel√©fono</label>
          <input class="form-control" name="telefono" placeholder="Ej. 7221234567">
        </div>
        <div class="col-md-4">
          <label class="form-label">Tipo</label>
          <select class="form-select" name="tipo">
            <option value="">Seleccione</option>
            <option value="personal">Personal</option>
            <option value="trabajo">Trabajo</option>
          </select>
        </div>
        <div class="col-md-2">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="principal">
            <label class="form-check-label">Principal</label>
          </div>
        </div>
        <div class="col-md-1 text-end">
          <button type="button" class="btn btn-outline-danger btn-sm btnRemove">X</button>
        </div>
      </div>
    `;
    div.querySelector('.btnRemove').addEventListener('click', () => div.remove());
    div.querySelector('input[name="principal"]').addEventListener('change', (e) => {
      if (e.target.checked) {
        document.querySelectorAll('#telefonosContainer input[name="principal"]').forEach(ch => {
          if (ch !== e.target) ch.checked = false;
        });
      }
    });
    return div;
  }
  function participacionBlock() {
    const div = document.createElement('div');
    div.className = 'list-item';
    div.innerHTML = `
      <div class="row g-2">
        <div class="col-12 col-md-3">
          <label class="form-label">Tipo</label>
          <select class="form-select" name="po_tipo">
            <option value="">Seleccione</option>
            <option value="partido">Partido</option>
            <option value="organizacion_social">Organizaci√≥n social</option>
            <option value="organizacion_politica">Organizaci√≥n pol√≠tica</option>
            <option value="otro">Otro</option>
          </select>
        </div>

        <div class="col-12 col-md-5">
          <label class="form-label">Nombre</label>
          <input class="form-control" name="po_nombre" placeholder="Nombre del partido/organizaci√≥n">
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Rol</label>
          <input class="form-control" name="po_rol" placeholder="Ej. integrante, dirigente, enlace">
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Periodo</label>
          <input class="form-control" name="po_periodo" placeholder="Ej. 2021-2023">
        </div>

        <div class="col-12 col-md-8">
          <label class="form-label">Notas</label>
          <input class="form-control" name="po_notas" placeholder="Opcional">
        </div>

        <div class="col-12 text-end">
          <button type="button" class="btn btn-outline-danger btn-sm btnRemove">Eliminar</button>
        </div>
      </div>
    `;
    div.querySelector('.btnRemove').addEventListener('click', () => {
      div.remove();
      refreshPreview?.();
    });
    return div;
  }
  //experiencia laboral 
  function expLabBlock() {
    const div = document.createElement('div');
    div.className = 'list-item';
    div.innerHTML = `
      <div class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Periodo</label>
          <input class="form-control" name="periodo" placeholder="2018-2021" maxlength="9">
        </div>
        <div class="col-md-4">
          <label class="form-label">Cargo</label>
          <input class="form-control" name="cargo" maxlength="120">
        </div>
        <div class="col-md-4">
          <label class="form-label">Organizaci√≥n o empresa</label>
          <input class="form-control" name="organizacion" maxlength="150">
        </div>
        <div class="col-md-1 text-end">
          <button type="button" class="btn btn-outline-danger btn-sm btnRemove">X</button>
        </div>
      </div>
    `;
    div.querySelector('.btnRemove').addEventListener('click', () => div.remove());
    return div;
  }

  document.getElementById("btnAddExpLab").addEventListener("click", () => {
    document.getElementById("expLabContainer").appendChild(expLabBlock());
  });


  let parejaCounter = 0;

  function parejaBlock() {
    parejaCounter += 1;
    const tempId = `p_${parejaCounter}`;

    const div = document.createElement('div');
    div.className = 'list-item';
    div.dataset.tempId = tempId;

    div.innerHTML = `
      <div class="row g-2 align-items-end">
        <div class="col-md-5">
          <label class="form-label">Nombre pareja</label>
          <input class="form-control" name="nombre_pareja" maxlength="150" autocomplete="off">
        </div>

        <div class="col-md-3">
          <label class="form-label">Tipo relaci√≥n</label>
          <select class="form-select" name="tipo_relacion">
            <option value="">Seleccione</option>
            <option value="actual">Actual</option>
            <option value="anterior">Anterior</option>
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label">A√±o o periodo</label>
          <input class="form-control" name="periodo"
                placeholder="2025 o 2015-2025"
                inputmode="numeric" autocomplete="off"
                maxlength="9">
          <div class="form-text">Formato: AAAA o AAAA-AAAA</div>
          <div class="invalid-feedback">Usa 2025 o 2015-2025.</div>
        </div>

        <div class="col-12 text-end mt-2">
          <button type="button" class="btn btn-outline-danger btn-sm btnRemove">Eliminar</button>
        </div>
      </div>
    `;

    div.querySelector('.btnRemove').addEventListener('click', () => {
      div.remove();
      refreshHijosParejasSelects();
    });

    // opcional: permitir s√≥lo d√≠gitos, espacios y guion
    div.addEventListener('input', () => {
      const inp = div.querySelector('input[name="periodo"]');
      if (inp) inp.value = inp.value.replace(/[^\d\- ]/g, '');
      refreshHijosParejasSelects();
    });
    div.addEventListener('change', refreshHijosParejasSelects);

    return div;
  }

 function hijoBlock() {
  const div = document.createElement('div');
  div.className = 'list-item';
  div.innerHTML = `
    <div class="row g-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label">Con qui√©n</label>
        <select class="form-select" name="pareja_temp_id">
          <option value="">(Sin especificar)</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">A√±o nacimiento</label>
        <input type="number" class="form-control" name="anio_nacimiento" min="1900" max="2100">
      </div>
      <div class="col-md-3">
        <label class="form-label">G√©nero</label>
        <select class="form-select" name="sexo">
          <option value="">Seleccione</option>
          <option value="F">F</option>
          <option value="M">M</option>
        </select>
      </div>
      <div class="col-md-1 text-end">
        <button type="button" class="btn btn-outline-danger btn-sm btnRemove">X</button>
      </div>
    </div>
  `;

  div.querySelector('.btnRemove').addEventListener('click', () => div.remove());

  // ‚úÖ llena SOLO este select (no depende del DOM global)
  const sel = div.querySelector('select[name="pareja_temp_id"]');
  fillHijoParejaSelect(sel);

  return div;
}


 function getParejasForSelect() {
  const items = [];
  document.querySelectorAll('#parejasContainer .list-item').forEach(p => {
    const tempId = p.dataset.tempId;
    const nombre = (p.querySelector('input[name="nombre_pareja"]')?.value || '').trim();
    const tipo = (p.querySelector('select[name="tipo_relacion"]')?.value || '').trim();

    if (!tempId) return;

    const label = `${nombre || 'Pareja'}${tipo ? ' (' + tipo + ')' : ''}`;
    items.push({ tempId, label });
  });
  return items;
}

function fillHijoParejaSelect(sel) {
  if (!sel) return;

  const current = sel.value;
  const parejas = getParejasForSelect();

  sel.innerHTML = `<option value="">(Sin especificar)</option>`;
  parejas.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.tempId;
    opt.textContent = `${p.label} [${p.tempId}]`;
    sel.appendChild(opt);
  });

  // conserva selecci√≥n si todav√≠a existe
  if (parejas.some(p => p.tempId === current)) sel.value = current;
}

function refreshHijosParejasSelects() {
  document.querySelectorAll('#hijosContainer select[name="pareja_temp_id"]').forEach(sel => {
    fillHijoParejaSelect(sel);
  });
}

  function redBlock() {
    const div = document.createElement('div');
    div.className = 'list-item';
    div.innerHTML = `
      <div class="row g-2 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Red</label>
          <select class="form-select" name="id_red"></select>
        </div>
        <div class="col-md-7">
          <label class="form-label">URL</label>
          <input class="form-control" name="url" placeholder="https://...">
        </div>
        <div class="col-md-1 text-end">
          <button type="button" class="btn btn-outline-danger btn-sm btnRemove">X</button>
        </div>
      </div>
    `;
    fillSelect(div.querySelector('select[name="id_red"]'), redesCatalog, 'id_red', 'nombre');
    div.querySelector('.btnRemove').addEventListener('click', () => div.remove());
    return div;
  }

  function servicioBlock() {
    const div = document.createElement('div');
    div.className = 'list-item';
    div.innerHTML = `
      <div class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Periodo</label>
          <input class="form-control" name="periodo" placeholder="2018-2021">
        </div>
        <div class="col-md-4">
          <label class="form-label">Cargo</label>
          <input class="form-control" name="cargo">
        </div>
        <div class="col-md-4">
          <label class="form-label">Dependencia</label>
          <input class="form-control" name="dependencia">
        </div>
        <div class="col-md-1 text-end">
          <button type="button" class="btn btn-outline-danger btn-sm btnRemove">X</button>
        </div>
      </div>
    `;
    div.querySelector('.btnRemove').addEventListener('click', () => div.remove());
    return div;
  }

  function eleccionBlock() {
    const div = document.createElement('div');
    div.className = 'list-item border rounded-3 p-3 mb-2';

    div.innerHTML = `
      <div class="row g-2">

        <div class="col-6 col-lg-2">
          <label class="form-label">A√±o</label>
          <input type="number" class="form-control" name="anio_eleccion" min="1900" max="2100" inputmode="numeric">
        </div>

        <div class="col-6 col-lg-2">
          <label class="form-label">Resultado</label>
          <select class="form-select" name="resultado">
            <option value="">Seleccione</option>
            <option value="ganada">Ganada</option>
            <option value="no_ganada">No ganada</option>
          </select>
        </div>

        <div class="col-12 col-lg-4">
          <label class="form-label">Candidatura</label>
          <input class="form-control" name="candidatura" placeholder="Ej. Presidencia municipal">
        </div>

        <div class="col-12 col-lg-2">
          <label class="form-label">Partido</label>
          <input class="form-control" name="partido_postulacion" placeholder="Ej. PAN / PRI / MORENA">
        </div>

        <div class="col-6 col-lg-1">
          <label class="form-label">Votos</label>
          <input type="number" class="form-control" name="diferencia_votos" min="0" inputmode="numeric">
        </div>

        <div class="col-6 col-lg-1">
          <label class="form-label">% Dif.</label>
          <div class="input-group">
            <input
              type="number"
              step="0.01"
              class="form-control"
              name="diferencia_porcentaje"
              min="0"
              max="100"
              inputmode="decimal"
            >
          </div>
        </div>

        <div class="col-12 d-flex justify-content-end">
          <button type="button" class="btn btn-outline-danger btn-sm btnRemove">
            Eliminar
          </button>
        </div>

      </div>
    `;

    div.querySelector('.btnRemove').addEventListener('click', () => div.remove());
    return div;
  }

  function equipoBlock() {
    const div = document.createElement('div');
    div.className = 'list-item';
    div.innerHTML = `
      <div class="row g-2 align-items-end">
        <div class="col-md-8">
          <label class="form-label">Nombre del equipo</label>
          <input class="form-control" name="nombre_equipo">
        </div>
        <div class="col-md-3">
          <label class="form-label">Activo</label>
          <select class="form-select" name="activo">
            <option value="true">Si</option>
            <option value="false">No</option>
          </select>
        </div>
        <div class="col-md-1 text-end">
          <button type="button" class="btn btn-outline-danger btn-sm btnRemove">X</button>
        </div>
      </div>
    `;
    div.querySelector('.btnRemove').addEventListener('click', () => div.remove());
    return div;
  }

  function referenteBlock() {
    const div = document.createElement('div');
    div.className = 'list-item';

    div.innerHTML = `
      <div class="row g-2 align-items-end">
        <div class="col-md-2">
          <label class="form-label">Nivel</label>
          <select class="form-select" name="nivel">
            <option value="">Seleccione</option>
            <option value="municipal">Municipal</option>
            <option value="regional">Regional</option>
            <option value="distrital">Distrital</option>
            <option value="estatal">Estatal</option>
            <option value="nacional">Nacional</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Nombre(s)</label>
          <input class="form-control" name="nombres" autocomplete="off">
        </div>

        <div class="col-md-3">
          <label class="form-label">Apellido paterno</label>
          <input class="form-control" name="apellido_paterno" autocomplete="off">
        </div>

        <div class="col-md-3">
          <label class="form-label">Apellido materno</label>
          <input class="form-control" name="apellido_materno" autocomplete="off">
        </div>

        <div class="col-md-1 text-end">
          <button type="button" class="btn btn-outline-danger btn-sm btnRemove">X</button>
        </div>
      </div>
    `;

    div.querySelector('.btnRemove').addEventListener('click', () => div.remove());
    return div;
  }


    function setControversiasUIState() {
      const chk = document.getElementById('chkSinControversias');
      const btn = document.getElementById('btnAddControversia');
      const cont = document.getElementById('controversiasContainer');
      const msg = document.getElementById('sinControversiasMsg');

      if (!chk || !btn || !cont || !msg) return;

      const activo = chk.checked;

      // Deshabilita bot√≥n y oculta contenedor
      btn.disabled = activo;
      cont.classList.toggle('opacity-50', activo);

      // Opcional: esconder el contenedor completo cuando est√° activo
      // cont.classList.toggle('d-none', activo);

      // Muestra mensaje
      msg.classList.toggle('d-none', !activo);

      // Si se activa, limpia controversias ya capturadas para evitar inconsistencia
      if (activo) {
        cont.innerHTML = '';
        // Si tienes un arreglo JS tipo controversiasState = [], l√≠mpialo tambi√©n aqu√≠
      }

      // Si tienes preview, refresca:
      // refreshPreview();
    }

  function controversiaBlock() {
    const div = document.createElement('div');
    div.className = 'list-item';
    div.innerHTML = `
      <div class="row g-2">
        <div class="col-md-4">
          <label class="form-label">Tipo</label>
          <select class="form-select" name="id_tipo"></select>
        </div>

        <div class="col-md-4">
          <label class="form-label">Periodo</label>
          <input type="date" class="form-control" name="fecha_registro">
        </div>

        <div class="col-md-8">
          <label class="form-label">Descripci√≥n</label>
          <textarea class="form-control" name="descripcion" rows="2"></textarea>
        </div>
        <div class="col-md-4">
          <label class="form-label">Fuente</label>
          <input class="form-control" name="fuente" placeholder="Medio / enlace / nota / N√∫m. de expte.">
        </div>

        <div class="col-12 text-end">
          <button type="button" class="btn btn-outline-danger btn-sm btnRemove">Eliminar</button>
        </div>
      </div>
    `;
    fillSelect(div.querySelector('select[name="id_tipo"]'), controversiasCatalog, 'id_tipo', 'tipo');
    div.querySelector('.btnRemove').addEventListener('click', () => div.remove());
    return div;
  }

  function familiarBlock() {
    const div = document.createElement('div');
    div.className = 'list-item';
    div.innerHTML = `
      <div class="row g-2 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Nombre</label>
          <input class="form-control" name="nombre">
        </div>
        <div class="col-md-2">
          <label class="form-label">Parentesco</label>
          <input class="form-control" name="parentesco" placeholder="Hermano / Padre / etc">
        </div>
        <div class="col-md-3">
          <label class="form-label">Cargo</label>
          <input class="form-control" name="cargo">
        </div>
        <div class="col-md-2">
          <label class="form-label">Instituci√≥n</label>
          <input class="form-control" name="institucion">
        </div>
        <div class="col-md-1 text-end">
          <button type="button" class="btn btn-outline-danger btn-sm btnRemove">X</button>
        </div>
      </div>
    `;
    div.querySelector('.btnRemove').addEventListener('click', () => div.remove());
    return div;
  }

  //Eleccion popular
  let cargoEleccionCounter = 0;

  function cargoEleccionBlock() {
    cargoEleccionCounter += 1;

    const div = document.createElement("div");
    div.className = "list-item";

    div.innerHTML = `
      <div class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Periodo</label>
          <input class="form-control" name="periodo" placeholder="2021 o 2018-2021" maxlength="9">
          <div class="invalid-feedback">Usa AAAA o AAAA-AAAA.</div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Cargo</label>
          <input class="form-control" name="cargo" maxlength="120">
          <div class="invalid-feedback">Indica el cargo.</div>
        </div>

        <div class="col-md-3">
          <label class="form-label">Partido postulante</label>
          <input class="form-control" name="partido_postulante" maxlength="120">
        </div>

        <div class="col-md-1">
          <label class="form-label">MR/RP</label>
          <select class="form-select" name="modalidad">
            <option value="">‚Äî</option>
            <option value="mr">MR</option>
            <option value="rp">RP</option>
          </select>
        </div>

        <div class="col-md-1 text-end">
          <button type="button" class="btn btn-outline-danger btn-sm btnRemove">X</button>
        </div>
      </div>
    `;

    div.querySelector(".btnRemove").addEventListener("click", () => div.remove());
    return div;
  }

  document.getElementById("btnAddCargoEleccion").addEventListener("click", () => {
    document.getElementById("cargosEleccionContainer").appendChild(cargoEleccionBlock());
  });
//funcion para habilitar los grados academicos:

  function toggleFormacionAcademicaUI() {
    const nivel = ($('#fa_nivel')?.value || '').trim();
    const requiere = (nivel === 'Educaci√≥n Superior' || nivel === 'Posgrado');

    const wrapGrado = $('#fa_grado_wrap');
    const wrapInst  = $('#fa_inst_wrap');
    const wrapTitulado = document.getElementById('faTituladoWrap');
    const inpGrado  = $('#fa_grado_obtenido');
    const inpInst   = $('#fa_institucion');

    wrapTitulado?.classList.toggle('d-none', !requiere);

    if (!requiere) {
      document.getElementById('fa_titulado').value = '';
    }

    if (!wrapGrado || !wrapInst || !inpGrado || !inpInst) return;

    wrapGrado.style.display = requiere ? '' : 'none';
    wrapInst.style.display  = requiere ? '' : 'none';

    inpGrado.required = requiere;
    inpInst.required  = requiere;

    // Si ya no aplica, limpia (evita ‚Äúbasura fantasma‚Äù en el payload)
    if (!requiere) {
      inpGrado.value = '';
      inpInst.value = '';
      inpGrado.classList.remove('is-invalid');
      inpInst.classList.remove('is-invalid');
    }
  }
  function toggleTemaOtroUI() {
    const wrap = document.getElementById('temaOtroWrap');
    const inp  = document.getElementById('temaOtroTexto');
    if (!wrap || !inp) return;

    const selectedIds = getSelectedTemasIds();
    const requiereOtro = (temasCatalog || []).some(t =>
      selectedIds.includes(Number(t.id_tema)) && !!t.requiere_otro_texto
    );

    wrap.classList.toggle('d-none', !requiereOtro);
    inp.required = requiereOtro;

    if (!requiereOtro) {
      inp.value = '';
      inp.classList.remove('is-invalid');
    }
  }

    function getSelectedTemasIds() {
      const ids = [];

      document.querySelectorAll('.tema-interes-chk:checked').forEach(chk => {
        const raw = chk.getAttribute('data-id'); // üëà m√°s fiable que dataset
        const n = parseInt(raw, 10);
        if (!Number.isNaN(n)) ids.push(n);
      });

      return ids;
    }
  // ---------- Build payload ----------
  function buildPayload() {
  const fd = new FormData($('#personaForm'));

  const munLegal   = toIntOrNull(fd.get('municipio_residencia_legal'));
  const munRealSel = toIntOrNull(fd.get('municipio_residencia_real'));
  const munTrabSel = toIntOrNull(fd.get('municipio_trabajo_politico'));

  const chkMunRealIgual    = $('#chkMunRealIgual')?.checked || false;
  const chkMunTrabajoIgual = $('#chkMunTrabajoIgual')?.checked || false;

  const selectedTemaIds = getSelectedTemasIds();
  const temas_interes = selectedTemaIds.map(id => ({ id_tema: id }));

  // --- Formaci√≥n acad√©mica (array, aunque hoy sea solo 1) ---
  const fa_nivel = (fd.get('fa_nivel') || '').toString().trim();
  const fa_grado_obtenido = (fd.get('fa_grado_obtenido') || '').toString().trim();
  const fa_institucion = (fd.get('fa_institucion') || '').toString().trim();
  let controversias = [];
  

  const persona = {
    nombre: (fd.get('nombre') || '').toString().trim(),
    apellido_paterno: (fd.get('apellido_paterno') ||'').toString().trim() || null,
    apellido_materno: (fd.get('apellido_materno') || '').toString().trim() || null,
    curp: (fd.get('curp') || '').toString().trim() || null,
    rfc: (fd.get('rfc') || '').toString().trim() || null,
    clave_elector: (fd.get('clave_elector') || '').toString().trim() || null,
    estado_civil: (fd.get('estado_civil') || '').toString().trim() || null,
    escala_influencia: (fd.get('escala_influencia') || '').toString().trim() || null,
    sin_servicio_publico: $('#sin_sp').checked,
    ha_contendido_eleccion: toBoolOrNull(fd.get('ha_contendido_eleccion')),
    partido_otro_texto: (fd.get('partido_otro_texto') || '').toString().trim() || null,
    foto_url: (document.getElementById("foto_url")?.value || "").trim() || null,
    // ‚ùå NO enviar creado_por: lo asigna el backend con req.user.id_usuario
    // creado_por: null,

    municipio_residencia_legal: munLegal,
    municipio_residencia_real: chkMunRealIgual ? munLegal : munRealSel,
    municipio_trabajo_politico: chkMunTrabajoIgual ? munLegal : munTrabSel,
    sin_controversias_publicas: document.getElementById('chkSinControversias')?.checked ?? false,
    id_partido_actual: toIntOrNull(fd.get('id_partido_actual')),
    id_grupo_postulacion: toIntOrNull(fd.get('id_grupo_postulacion')),
    id_ideologia_politica: toIntOrNull(fd.get('id_ideologia_politica')),
  };
  const formacion_academica = [];
  if (fa_nivel) {
    const requiere = (fa_nivel === 'Educaci√≥n Superior' || fa_nivel === 'Posgrado');
    const fa_titulado_raw = fd.get('fa_titulado');
    const fa_titulado =
      fa_titulado_raw === '' ? null : (fa_titulado_raw === 'true');

    // validaci√≥n front r√°pida (backend tambi√©n valida)
    if (requiere) {
      const ok = !!fa_grado_obtenido && !!fa_institucion;
      $('#fa_grado_obtenido')?.classList.toggle('is-invalid', !fa_grado_obtenido);
      $('#fa_institucion')?.classList.toggle('is-invalid', !fa_institucion);

      if (!ok) {
        // OJO: aqu√≠ no hacemos throw para no romper el preview,
        // se validar√° al submit tambi√©n (abajo te digo).
      }
    }

    formacion_academica.push({
      nivel: fa_nivel,
      grado_obtenido: requiere ? (fa_grado_obtenido || null) : null,
      institucion: requiere ? (fa_institucion || null) : null,
      titulado: requiere ? fa_titulado : null
      // anio_inicio/anio_fin si luego los agregas
    });
  }

    const telefonos = [];
    document.querySelectorAll('#telefonosContainer .list-item').forEach(item => {
      const telefono = item.querySelector('input[name="telefono"]').value.trim();
      const tipo = item.querySelector('select[name="tipo"]').value.trim();
      const principal = item.querySelector('input[name="principal"]').checked;
      if (telefono) telefonos.push({ telefono, tipo: tipo || null, principal });
    });
//parejas
    function normalizePeriodo(str) {
      return (str || "").toString().replace(/\s+/g, "").trim();
    }

    function isPeriodoValido(p) {
      if (!p) return true;
      if (!/^(\d{4}|\d{4}-\d{4})$/.test(p)) return false;

      const m = p.match(/^(\d{4})-(\d{4})$/);
      if (m) {
        const a = Number(m[1]), b = Number(m[2]);
        if (b < a) return false;
      }
      return true;
    }

    const parejas = [];
    document.querySelectorAll('#parejasContainer .list-item').forEach(item => {
      const nombre_pareja = item.querySelector('input[name="nombre_pareja"]').value.trim();
      const tipo_relacion = item.querySelector('select[name="tipo_relacion"]').value.trim();

      const periodoInput = item.querySelector('input[name="periodo"]');
      const periodo = normalizePeriodo(periodoInput?.value);

      // si el bloque tiene algo, valida periodo (si viene)
      if ((nombre_pareja || tipo_relacion || periodo) && !isPeriodoValido(periodo)) {
        periodoInput.classList.add("is-invalid");
      } else if (periodoInput) {
        periodoInput.classList.remove("is-invalid");
      }

      if (nombre_pareja || tipo_relacion || periodo) {
        parejas.push({
          temp_id: item.dataset.tempId,
          nombre_pareja: nombre_pareja || null,
          tipo_relacion: tipo_relacion || null,
          periodo: periodo || null
        });
      }
    });
//hijos
    const hijos = [];
    document.querySelectorAll('#hijosContainer .list-item').forEach(item => {
      const pareja_temp_id = item.querySelector('select[name="pareja_temp_id"]').value || null;
      const anio = item.querySelector('input[name="anio_nacimiento"]').value;
      const sexo = item.querySelector('select[name="sexo"]').value.trim();
      if (anio || sexo) hijos.push({ pareja_temp_id, anio_nacimiento: anio ? Number(anio) : null, sexo: sexo || null });
    });

    const redes = [];
    document.querySelectorAll('#redesContainer .list-item').forEach(item => {
      const id_red = item.querySelector('select[name="id_red"]').value;
      const url = item.querySelector('input[name="url"]').value.trim();
      if (id_red && url) redes.push({ id_red: Number(id_red), url });
    });

    const servicio_publico = [];
    document.querySelectorAll('#servicioContainer .list-item').forEach(item => {
      const periodo = item.querySelector('input[name="periodo"]').value.trim();
      const cargo = item.querySelector('input[name="cargo"]').value.trim();
      const dependencia = item.querySelector('input[name="dependencia"]').value.trim();
      if (periodo || cargo || dependencia) servicio_publico.push({ periodo: periodo||null, cargo: cargo||null, dependencia: dependencia||null });
    });

    //elecciones
    const haContendido = toBoolOrNull(fd.get('ha_contendido_eleccion'));
    const elecciones = [];
    document.querySelectorAll('#eleccionesContainer .list-item').forEach(item => {
      const anio = item.querySelector('input[name="anio_eleccion"]').value;
      const candidatura = item.querySelector('input[name="candidatura"]').value.trim();
      const partido_postulacion = item.querySelector('input[name="partido_postulacion"]').value.trim();
      const resultado = item.querySelector('select[name="resultado"]').value.trim();
      const diferencia_votos = item.querySelector('input[name="diferencia_votos"]').value;
      const diferencia_porcentaje = item.querySelector('input[name="diferencia_porcentaje"]').value;
      const tieneAlgo = anio || candidatura || partido_postulacion || resultado || diferencia_votos || diferencia_porcentaje;
      if (tieneAlgo) {
        elecciones.push({
          anio_eleccion: anio ? Number(anio) : null,
          candidatura: candidatura || null,
          partido_postulacion: partido_postulacion || null,
          resultado: resultado || null,
          diferencia_votos: diferencia_votos ? Number(diferencia_votos) : null,
          diferencia_porcentaje: diferencia_porcentaje ? Number(diferencia_porcentaje) : null
        });
      }
      if (haContendido === false) {
        elecciones.length = 0; // fuerza vac√≠o
      }
    });
    //experiencia laboral 
    const experiencia_laboral = [];
    document.querySelectorAll('#expLabContainer .list-item').forEach(item => {
      const periodo = item.querySelector('input[name="periodo"]').value.trim();
      const cargo = item.querySelector('input[name="cargo"]').value.trim();
      const organizacion = item.querySelector('input[name="organizacion"]').value.trim();

      if (periodo || cargo || organizacion) {
        experiencia_laboral.push({
          periodo: periodo || null,
          cargo: cargo || null,
          organizacion: organizacion || null
        });
      }
    });
    //movilizacion

    const capacidad_movilizacion_eventos = [];
    document.querySelectorAll('#movEventosContainer .list-item').forEach(item => {
      const nombre_evento = item.querySelector('input[name="mov_nombre_evento"]').value.trim();
      const fecha_evento  = item.querySelector('input[name="mov_fecha_evento"]').value;

      const asisVal = item.querySelector('input[name="mov_asistencia_evento"]').value;
      const asistencia = (asisVal === '' ? null : Number(asisVal));

      const tieneAlgo = nombre_evento || fecha_evento || asistencia != null;

      if (tieneAlgo) {
        capacidad_movilizacion_eventos.push({
          nombre_evento: nombre_evento || null,
          fecha_evento: fecha_evento || null,
          asistencia: (asistencia == null || Number.isNaN(asistencia)) ? null : asistencia
        });
      }
    });

    // si ‚ÄúOtro‚Äù est√° seleccionado, agrega texto
    const temaOtro = (temasCatalog || []).find(t =>
      selectedTemaIds.includes(Number(t.id_tema)) && !!t.requiere_otro_texto
    );

    if (temaOtro) {
      const txt = (document.getElementById('temaOtroTexto')?.value || '').trim();
      const obj = temas_interes.find(x => x.id_tema === Number(temaOtro.id_tema));
      if (obj) obj.otro_texto = txt || null;
    }

    const equipos = [];
    document.querySelectorAll('#equiposContainer .list-item').forEach(item => {
      const nombre_equipo = item.querySelector('input[name="nombre_equipo"]').value.trim();
      const activo = item.querySelector('select[name="activo"]').value;
      if (nombre_equipo) equipos.push({ nombre_equipo, activo: activo === 'true' });
    });

    //referentes
function cleanText(v) {
  return (v || "").toString().trim().replace(/\s+/g, " "); // colapsa espacios dobles
}

  const referentes = [];
  let referentesInvalidos = 0;

  document.querySelectorAll('#referentesContainer .list-item').forEach(item => {
    const nivelEl = item.querySelector('select[name="nivel"]');
    const nombresEl = item.querySelector('input[name="nombres"]');
    const apEl = item.querySelector('input[name="apellido_paterno"]');
    const amEl = item.querySelector('input[name="apellido_materno"]');

    const nivel = cleanText(nivelEl.value);
    const nombres = cleanText(nombresEl.value);
    const apellido_paterno = cleanText(apEl.value);
    const apellido_materno = cleanText(amEl.value);

    const tieneAlgo = nivel || nombres || apellido_paterno || apellido_materno;
    if (!tieneAlgo) {
      // limpia estados por si borraron todo
      nivelEl.classList.remove("is-invalid");
      nombresEl.classList.remove("is-invalid");
      return;
    }

    // Validaci√≥n suave: si captur√≥ algo, exige nivel + nombres
    const okNivel = !!nivel;
    const okNombres = !!nombres;

    nivelEl.classList.toggle("is-invalid", !okNivel);
    nombresEl.classList.toggle("is-invalid", !okNombres);

    if (!okNivel || !okNombres) {
      referentesInvalidos += 1;
      return; // no metemos al payload si est√° incompleto
    }

    referentes.push({
      nivel: nivel || null,
      nombres: nombres || null,
      apellido_paterno: apellido_paterno || null,
      apellido_materno: apellido_materno || null
    });
  });

  // Si quieres bloquear submit:
  if (referentesInvalidos > 0) {
    // muestra alerta / toast / etc.
    // return;
  }

    if (!persona.sin_controversias_publicas) {
      document.querySelectorAll('#controversiasContainer .list-item').forEach(item => {
        const id_tipo = item.querySelector('select[name="id_tipo"]').value;
        const fecha_registro = item.querySelector('input[name="fecha_registro"]').value;
        const descripcion = item.querySelector('textarea[name="descripcion"]').value.trim();
        const fuente = item.querySelector('input[name="fuente"]').value.trim();
        const tieneAlgo = id_tipo || fecha_registro || descripcion || fuente;

        if (tieneAlgo) {
          controversias.push({
            id_tipo: id_tipo ? Number(id_tipo) : null,
            fecha_registro: fecha_registro || null,
            descripcion: descripcion || null,
            fuente: fuente || null
          });
        }
      });
    }

    const datos_ine = {
      seccion_electoral: (fd.get('ine_seccion') || '').toString().trim() || null,
      distrito_federal: (fd.get('ine_df') || '').toString().trim() || null,
      distrito_local: (fd.get('ine_dl') || '').toString().trim() || null
    };
    const datosINEFinal = (datos_ine.seccion_electoral || datos_ine.distrito_federal || datos_ine.distrito_local) ? datos_ine : null;

    const familiares = [];
    document.querySelectorAll('#familiaresContainer .list-item').forEach(item => {
      const nombre = item.querySelector('input[name="nombre"]').value.trim();
      const parentesco = item.querySelector('input[name="parentesco"]').value.trim();
      const cargo = item.querySelector('input[name="cargo"]').value.trim();
      const institucion = item.querySelector('input[name="institucion"]').value.trim();
      if (nombre || parentesco || cargo || institucion) {
        familiares.push({
          nombre: nombre || null,
          parentesco: parentesco || null,
          cargo: cargo || null,
          institucion: institucion || null
        });
      }
    });

    let participacion_organizaciones = [];
    document.querySelectorAll('#participacionContainer .list-item').forEach(item => {
      const tipo = (item.querySelector('select[name="po_tipo"]').value || '').trim();
      const nombre = (item.querySelector('input[name="po_nombre"]').value || '').trim();
      const rol = (item.querySelector('input[name="po_rol"]').value || '').trim();
      const periodo = (item.querySelector('input[name="po_periodo"]').value || '').trim();
      const notas = (item.querySelector('input[name="po_notas"]').value || '').trim();

      const tieneAlgo = tipo || nombre || rol || periodo || notas;
      if (!tieneAlgo) return;

      // Nombre es lo importante si capturan algo
      if (!nombre) return;

      participacion_organizaciones.push({
        tipo: tipo || 'otro',
        nombre,
        rol: rol || null,
        periodo: periodo || null,
        notas: notas || null
      });
    });

    function normalizePeriodo(str) {
      return (str || "").toString().replace(/\s+/g, "").trim();
    }
    function isPeriodoValido(p) {
      if (!p) return true;
      if (!/^(\d{4}|\d{4}-\d{4})$/.test(p)) return false;
      const m = p.match(/^(\d{4})-(\d{4})$/);
      return !m || Number(m[2]) >= Number(m[1]);
    }

    const sin_cargos_eleccion_popular = document.getElementById("chkSinCargosEleccion").checked;

    const cargos_eleccion_popular = [];
    let invalidos = 0;

    document.querySelectorAll("#cargosEleccionContainer .list-item").forEach(item => {
      const periodoEl = item.querySelector('input[name="periodo"]');
      const cargoEl = item.querySelector('input[name="cargo"]');

      const periodo = normalizePeriodo(periodoEl.value);
      const cargo = cargoEl.value.trim();
      const partido_postulante = item.querySelector('input[name="partido_postulante"]').value.trim();
      const modalidad = item.querySelector('select[name="modalidad"]').value.trim();

      const tieneAlgo = periodo || cargo || partido_postulante || modalidad;
      if (!tieneAlgo) return;

      // si hay registro, exige periodo + cargo
      const okPeriodo = !!periodo && isPeriodoValido(periodo);
      const okCargo = !!cargo;

      periodoEl.classList.toggle("is-invalid", !okPeriodo);
      cargoEl.classList.toggle("is-invalid", !okCargo);

      if (!okPeriodo || !okCargo) { invalidos += 1; return; }

      cargos_eleccion_popular.push({
        periodo: periodo || null,
        cargo: cargo || null,
        partido_postulante: partido_postulante || null,
        modalidad: modalidad || null
      });
    });
  
    // Guardar en persona (consistencia)
    persona.sin_cargos_eleccion_popular = sin_cargos_eleccion_popular;
    // arreglo final (si marc√≥ "sin cargos" => forzar vac√≠o)
    const cargosEleccionFinal = sin_cargos_eleccion_popular ? [] : cargos_eleccion_popular;
    return {
      persona,
      datos_ine: datosINEFinal,
      telefonos,
      parejas,
      hijos,
      redes,
      servicio_publico,
      elecciones,
      cargos_eleccion_popular: cargosEleccionFinal,   // ‚úÖ AQUI
      capacidad_movilizacion_eventos,
      equipos,
      referentes,
      controversias,
      familiares,
      formacion_academica,
      temas_interes,
      experiencia_laboral,
      participacion_organizaciones
    };
  }

function refreshPreview() {
  try {
    const payload = buildPayload();

    const pre = document.getElementById('payloadPreview');
    if (pre) {
      pre.textContent = JSON.stringify(payload, null, 2);
    }

    // si tienes otras cosas en preview, igual prot√©gelas
  } catch (e) {
    console.warn('refreshPreview error:', e);
    // NO dispares showAlert aqu√≠, porque se llama en cada input/change
  }
}

  function clearAll() {
    $('#personaForm').reset();

    // limpiar contenedores
    $('#telefonosContainer').innerHTML = '';
    $('#parejasContainer').innerHTML = '';
    $('#hijosContainer').innerHTML = '';
    $('#redesContainer').innerHTML = '';
    $('#servicioContainer').innerHTML = '';
    $('#eleccionesContainer').innerHTML = '';
    $('#equiposContainer').innerHTML = '';
    $('#referentesContainer').innerHTML = '';
    $('#controversiasContainer').innerHTML = '';
    $('#familiaresContainer').innerHTML = '';
    $('#participacionContainer').innerHTML = ''; // ‚úÖ nuevo

    // re-seed m√≠nimos
    $('#telefonosContainer').appendChild(telefonoBlock());
    $('#parejasContainer').appendChild(parejaBlock());
    $('#hijosContainer').appendChild(hijoBlock());
    $('#redesContainer').appendChild(redBlock());
    $('#servicioContainer').appendChild(servicioBlock());
    $('#eleccionesContainer').appendChild(eleccionBlock());
    $('#equiposContainer').appendChild(equipoBlock());
    $('#referentesContainer').appendChild(referenteBlock());
    $('#familiaresContainer').appendChild(familiarBlock());

    // ‚úÖ controversias: si NO est√° activado "sin controversias", seed 1 fila
    const chkSin = document.getElementById('chkSinControversias');
    const sinCont = chkSin?.checked === true;
    if (!sinCont) {
      $('#controversiasContainer').appendChild(controversiaBlock());
    } else {
      $('#controversiasContainer').innerHTML = '';
    }

    // ‚úÖ Estado UI dependiente de selects/checkboxes
    if (typeof toggleTemaOtroUI === 'function') toggleTemaOtroUI();        // Tema "Otro"
    if (typeof setControversiasUIState === 'function') setControversiasUIState(); // Sin controversias
    document.getElementById('movEventosContainer').innerHTML = '';
    document.getElementById('movEventosContainer').appendChild(movEventoBlock());

    // ‚úÖ limpiar foto
    const inpFoto = document.getElementById("inpFoto");
    const previewFoto = document.getElementById("previewFoto");
    const hidFotoUrl = document.getElementById("foto_url");

    if (inpFoto) inpFoto.value = "";          // limpia el file input
    if (hidFotoUrl) hidFotoUrl.value = "";     // limpia URL guardada
    if (previewFoto) {
      previewFoto.src = "";
      previewFoto.classList.add("d-none");     // oculta preview
    }
    hideAlert();
    refreshPreview();
  }
        //domcontainer
      document.addEventListener("DOMContentLoaded", () => {
        const chk = document.getElementById("chkSinCargosEleccion");
        const section = document.getElementById("cargosEleccionSection");
        const container = document.getElementById("cargosEleccionContainer");
        const btnAdd = document.getElementById("btnAddCargoEleccion");

        function clearValidationInside(el) {
          el.querySelectorAll(".is-invalid, .is-valid").forEach(x => {
            x.classList.remove("is-invalid", "is-valid");
          });
        }

        function setSinCargosUI() {
          if (!chk || !section || !container) return;

          const sin = chk.checked;

          // Oculta / muestra secci√≥n
          section.classList.toggle("d-none", sin);

          // (opcional) deshabilita el bot√≥n de agregar
          if (btnAdd) btnAdd.disabled = sin;

          if (sin) {
            // Limpia todo el contenido
            container.innerHTML = "";

            // Limpia cualquier estado visual por si qued√≥ algo en memoria del DOM
            clearValidationInside(section);
          } else {
            // Si vuelven a habilitar, quita estados raros
            clearValidationInside(section);
          }
        }

        chk.addEventListener("change", setSinCargosUI);
        setSinCargosUI();
      });
       //togle ocultar sin servicio publico:
      document.addEventListener("DOMContentLoaded", () => {
        const chk = document.getElementById("sin_sp");
        const section = document.getElementById("servicioPublicoSection");
        const container = document.getElementById("servicioContainer");
        const btnAdd = document.getElementById("btnAddServicio");

        function clearValidationInside(el) {
          el.querySelectorAll(".is-invalid, .is-valid").forEach(x => {
            x.classList.remove("is-invalid", "is-valid");
          });
        }

        function setSinServicioUI() {
          if (!chk || !section || !container) return;

          const sin = chk.checked;

          section.classList.toggle("d-none", sin);
          if (btnAdd) btnAdd.disabled = sin;

          if (sin) {
            container.innerHTML = "";
            clearValidationInside(section);
          } else {
            clearValidationInside(section);
          }
        }

        chk.addEventListener("change", setSinServicioUI);
        setSinServicioUI();
      });
      //foto
      document.addEventListener("DOMContentLoaded", () => {
        const inpFoto = document.getElementById("inpFoto");
        const preview = document.getElementById("previewFoto");
        const hidFotoUrl = document.getElementById("foto_url");

        if (!inpFoto || !preview || !hidFotoUrl) return;

        inpFoto.addEventListener("change", async () => {
          const file = inpFoto.files?.[0];
          if (!file) return;

          // preview
          preview.src = URL.createObjectURL(file);
          preview.classList.remove("d-none");

          // upload
          const fd = new FormData();
          fd.append("foto", file);

          const resp = await fetch("/api/upload/foto", { method: "POST", body: fd });
          const data = await resp.json().catch(() => ({}));

          if (!resp.ok) {
            alert(data?.error || "Error al subir foto");
            return;
          }

          hidFotoUrl.value = data.foto_url; // ‚úÖ se guarda para el payload
        });
      });

    //funcion para validar:
    function initValidacionDuplicados() {
      let dupTimer = null;

      const getByName = (name) => document.querySelector(`[name="${name}"]`);
     
      const normalize = (v) => (v || "").toString().trim();

      async function checkDuplicado() {

        await checkDuplicadoNow(window.editingId || null);
        const curp = normalize(getByName("curp")?.value).toUpperCase();
        const rfc  = normalize(getByName("rfc")?.value).toUpperCase();

        const nombre = normalize(getByName("nombre")?.value);
        const ap = normalize(getByName("apellido_paterno")?.value);
        const am = normalize(getByName("apellido_materno")?.value);

        const mun = normalize(getByName("municipio_residencia_legal")?.value);

        const clave_elector = normalize(getByName("clave_elector")?.value).toUpperCase();
        const seccion_electoral = normalize(getByName("ine_seccion")?.value);

        const exclude_id = (window.editingId || null); // o usa tu variable editingId

        // no molestar si todav√≠a no hay nada relevante
        if (!curp && !rfc && !clave_elector && !seccion_electoral && !(nombre && ap)) return;

        const qs = new URLSearchParams({
          curp,
          rfc,
          nombre,
          apellido_paterno: ap,
          apellido_materno: am,
          municipio: mun,
          clave_elector,
          seccion_electoral,
          exclude_id: exclude_id ? String(exclude_id) : ""
        });

        // Usa tu helper apiGet si ya mete Authorization autom√°ticamente
        // Si no, usa fetch con token.
        let resp, data;

        try {
          // Si ya tienes apiGet:
          if (typeof apiGet === "function") {
            data = await apiGet(`/personas/check-duplicado?${qs.toString()}`);
          } else {
            const token = localStorage.getItem("token");
            resp = await fetch(`/api/personas/check-duplicado?${qs.toString()}`, {
              headers: { Authorization: `Bearer ${token}` }
            });
            data = await resp.json().catch(() => ({}));
            if (!resp.ok) return;
          }
        } catch (e) {
          console.warn("checkDuplicado error:", e);
          return;
        }

        const results = data?.results || [];
        window.__dupCheck = results;

        if (results.length) {
          if (typeof showAlert === "function") {
            showAlert("warning", "Posible duplicado detectado. Revisa antes de guardar.");
          }
          console.log("DUPLICADOS:", results);
        } else {
          window.__dupCheck = [];
          // opcional: si quieres quitar alerta cuando ya no hay duplicados
          // if (typeof hideAlert === "function") hideAlert();
        }
      }

      function debounceCheck() {
        clearTimeout(dupTimer);
        dupTimer = setTimeout(checkDuplicado, 450);
      }

      // engancha a los campos principales
      const fields = [
        "curp",
        "rfc",
        "nombre",
        "apellido_paterno",
        "apellido_materno",
        "municipio_residencia_legal",
        "clave_elector",
        "ine_seccion"
      ];

      fields.forEach(name => {
        const el = getByName(name);
        if (!el) return;
        el.addEventListener("blur", checkDuplicado);
        el.addEventListener("input", debounceCheck);
        el.addEventListener("change", debounceCheck);
      });

      async function checkDuplicadoNow(excludeId) {
        const curp = normalize(getByName("curp")?.value).toUpperCase();
        const rfc  = normalize(getByName("rfc")?.value).toUpperCase();

        const nombre = normalize(getByName("nombre")?.value);
        const ap = normalize(getByName("apellido_paterno")?.value);
        const am = normalize(getByName("apellido_materno")?.value);

        const mun = normalize(getByName("municipio_residencia_legal")?.value);

        const clave_elector = normalize(getByName("clave_elector")?.value).toUpperCase();
        // OJO: tu input se llama ine_seccion en el form (no seccion_electoral)
        const seccion_electoral = normalize(getByName("ine_seccion")?.value);

        if (!curp && !rfc && !(nombre && ap) && !clave_elector && !seccion_electoral) {
          window.__dupCheck = [];
          return [];
        }

        const qs = new URLSearchParams({
          curp,
          rfc,
          nombre,
          apellido_paterno: ap,
          apellido_materno: am,
          municipio: mun,
          clave_elector,
          seccion_electoral,
          exclude_id: excludeId ? String(excludeId) : ""
        });

        const data = await apiGet(`/personas/check-duplicado?${qs.toString()}`);
        const results = data?.results || [];
        window.__dupCheck = results;
        return results;
      }

      // üëá exp√≥n para usarlo en submit
      window.checkDuplicadoNow = checkDuplicadoNow;

    }
  // ---------- init ----------
  (async function init() {
    let partidosCatalog = [];
    let gruposCatalog = [];
    hideAlert();
    try {
      municipiosCache = await apiGet('/municipios');
      redesCatalog = await apiGet('/catalogos/redes');
      controversiasCatalog = await apiGet('/catalogos/controversias');
      partidosCatalog = await apiGet('/catalogos/partidos');
      temasCatalog = await apiGet('/catalogos/temas-interes');
      gruposCatalog = await apiGet('/catalogos/grupos-postulacion');
      ideologiasCatalog = await apiGet('/catalogos/ideologias');

      fillSelect($('#mun_legal'), municipiosCache, 'id_municipio', 'nombre');
      fillSelect($('#mun_real'), municipiosCache, 'id_municipio', 'nombre');
      fillSelect($('#mun_trabajo'), municipiosCache, 'id_municipio', 'nombre');

      fillSelect($('#selPartidoActual'), partidosCatalog, 'id_partido', 'nombre');
      fillSelect($('#selGrupoPostulacion'), gruposCatalog, 'id_grupo', 'nombre');
      fillSelect($('#selIdeologia'), ideologiasCatalog, 'id_ideologia', 'nombre');

      const munLegal = document.getElementById('mun_legal');
      const munReal = document.getElementById('mun_real');
      const munTrabajo = document.getElementById('mun_trabajo');

      const chkMunRealIgual = document.getElementById('chkMunRealIgual');
      const chkMunTrabajoIgual = document.getElementById('chkMunTrabajoIgual');

      function syncMunicipio(selectTarget, checked) {
        if (checked) {
          selectTarget.value = munLegal.value;
          selectTarget.disabled = true;
        } else {
          selectTarget.disabled = false;
        }
      }

      // Cuando cambia el municipio legal
      munLegal.addEventListener('change', () => {
        if (chkMunRealIgual.checked) {
          munReal.value = munLegal.value;
        }
        if (chkMunTrabajoIgual.checked) {
          munTrabajo.value = munLegal.value;
        }
      });

      // Checkbox residencia real
      chkMunRealIgual.addEventListener('change', (e) => {
        syncMunicipio(munReal, e.target.checked);
      });

      // Checkbox trabajo pol√≠tico
      chkMunTrabajoIgual.addEventListener('change', (e) => {
        syncMunicipio(munTrabajo, e.target.checked);
      });

      // seed blocks
      clearAll();
      setControversiasUIState();

      togglePartidoOtroUI();
      renderTemasInteresCheckboxes();

      document.getElementById('temasInteresChecks')?.addEventListener('change', () => {
        toggleTemaOtroUI();
        refreshPreview?.();
      });

      document.getElementById('selHaContendido')?.addEventListener('change', () => {
        setEleccionesUIState();
        refreshPreview?.();
      });
      // Estado inicial
      setEleccionesUIState();
      //eventos
      document.getElementById('btnAddMovEvento')?.addEventListener('click', () => {
        document.getElementById('movEventosContainer')?.appendChild(movEventoBlock());
        refreshPreview?.();
      });

      document.getElementById('chkSinControversias')?.addEventListener('change', () => {
        setControversiasUIState();
        refreshPreview();
      });
      //nvel
      $('#fa_nivel')?.addEventListener('change', () => {
        toggleFormacionAcademicaUI();
        refreshPreview();
      });
      // buttons add
      $('#btnAddTelefono').addEventListener('click', () => { $('#telefonosContainer').appendChild(telefonoBlock()); refreshPreview(); });
      $('#btnAddPareja').addEventListener('click', () => {
        const pb = parejaBlock();
        $('#parejasContainer').appendChild(pb);

        // üî• importante: ahora s√≠ el DOM ya tiene la nueva pareja
        refreshHijosParejasSelects();
        toggleFormacionAcademicaUI();
        refreshPreview();
      });

      $('#btnAddHijo').addEventListener('click', () => {
        const hb = hijoBlock();
        $('#hijosContainer').appendChild(hb);

        // opcional: por si quieres sincronizar todos siempre
        // refreshHijosParejasSelects();

        refreshPreview();
      });
      // Cargar lista al iniciar
      await cargarListaBorradores();
      setBorradorActual(null);
      initValidacionDuplicados();

      //editar,eliminar persona

      function setEditing(id_persona) {
        editingId = Number(id_persona);

        // habilitar botones del offcanvas
        const btnSalir = document.getElementById('btnSalirEdicion');
        const btnEliminar = document.getElementById('btnEliminarPersona');

        if (btnSalir) btnSalir.disabled = false;
        if (btnEliminar) btnEliminar.disabled = false;

        // cambia texto del bot√≥n principal (si existe)
        const btnSubmit = document.getElementById('btnSubmitPersona');
        if (btnSubmit) btnSubmit.textContent = 'Guardar cambios';

        // guarda id si usas hidden
        const hid = document.getElementById('id_persona');
        if (hid) hid.value = String(editingId);
      }

    async function buscarPersonas(q) {
      const data = await apiGet(`/personas?search=${encodeURIComponent(q || '')}&limit=30`);
      return data.items || data;
    }

    function renderListaPersonas(items) {
      const cont = document.getElementById("listaPersonas");
      if (!cont) return;
      cont.innerHTML = "";

      if (!items.length) {
        cont.innerHTML = `<div class="text-muted">Sin resultados</div>`;
        return;
      }

      items.forEach(p => {
        const a = document.createElement("button");
        a.type = "button";
        a.className = "list-group-item list-group-item-action";
        a.innerHTML = `
          <div class="fw-semibold">${p.nombre} ${p.apellido_paterno || ''} ${p.apellido_materno || ''}</div>
          <div class="small text-muted">ID: ${p.id_persona}</div>
        `;
        
        document.getElementById("btnBuscarPersona")?.addEventListener("click", recargarLista);
        a.addEventListener("click", async () => {
          try {
            const payload = await apiGet(`/personas/${p.id_persona}/payload`); // ‚úÖ aqu√≠
            applyPayloadToForm(payload);
            setEditing(p.id_persona);
            showAlert("info", `Modo edici√≥n: #${p.id_persona}`);
          } catch (e) {
            console.error(e);
            showAlert("danger", "No pude cargar para edici√≥n: " + e.message);
          }
        });

        cont.appendChild(a);
      });
    }

      async function recargarLista() {
        const q = document.getElementById("txtBuscarPersona").value.trim();
        const items = await buscarPersonas(q);
        renderListaPersonas(items);
      }

      document.getElementById("btnBuscarPersona").addEventListener("click", recargarLista);
      document.getElementById("txtBuscarPersona").addEventListener("keydown", (e) => {
        if (e.key === "Enter") recargarLista();
      });

      //final editar eliminar

      // Bot√≥n recargar
      document.getElementById('btnRecargarBorradores').addEventListener('click', async () => {
        await cargarListaBorradores();
      });

      // Guardar borrador (create o update)
      document.getElementById('btnGuardarBorrador').addEventListener('click', async () => {
        try {
          const payload = buildPayload();

          const fa0 = (payload.formacion_academica || [])[0];

          if (fa0 && (fa0.nivel === 'Educaci√≥n Superior' || fa0.nivel === 'Posgrado')) {
            if (!fa0.grado_obtenido || !fa0.institucion) {
              showAlert(
                'warning',
                'Borrador guardado, pero falta ‚ÄúGrado obtenido‚Äù e ‚ÄúInstituci√≥n‚Äù para Educaci√≥n Superior/Posgrado.'
              );
              // OJO: no hacemos return, porque es borrador
            }
          }
          const titulo = generarTituloBorrador(payload);

          if (!borradorActualId) {
            const resp = await apiPost('/borradores', { titulo, payload });
            setBorradorActual(resp.id_borrador);
            await cargarListaBorradores();
            showAlert('success', `Borrador guardado ‚úÖ (#${resp.id_borrador})`);
          } else {
            await apiPut(`/borradores/${borradorActualId}`, { titulo, payload, estatus: 'borrador' });
            await cargarListaBorradores();
            showAlert('success', `Borrador actualizado ‚úÖ (#${borradorActualId})`);
          }

          refreshPreview();
        } catch (e) {
          console.error(e);
          showAlert('danger', 'Error al guardar borrador: ' + e.message);
        }
      });

      // Cargar borrador desde select
      document.getElementById('selBorradores').addEventListener('change', async (e) => {
        const id = e.target.value;
        if (!id) return;

        try {
          const b = await apiGet(`/borradores/${id}`);
          setBorradorActual(b.id_borrador);
          applyPayloadToForm(b.payload);
          showAlert('info', `Borrador cargado (#${b.id_borrador})`);
        } catch (err) {
          console.error(err);
          showAlert('danger', 'No pude cargar borrador: ' + err.message);
        }
      });

 

      // Eliminar borrador actual
      document.getElementById('btnEliminarBorrador').addEventListener('click', async () => {
        if (!borradorActualId) return;

        try {
          await apiDelete(`/borradores/${borradorActualId}`);
          showAlert('success', `Borrador eliminado ‚úÖ (#${borradorActualId})`);
          setBorradorActual(null);
          await cargarListaBorradores();
        } catch (e) {
          console.error(e);
          showAlert('danger', 'No pude eliminar borrador: ' + e.message);
        }
      });

      document.getElementById('btnAddParticipacion')?.addEventListener('click', () => {
        document.getElementById('participacionContainer')?.appendChild(participacionBlock());
        refreshPreview?.();
      });

      $('#btnAddRed').addEventListener('click', () => { $('#redesContainer').appendChild(redBlock()); refreshPreview(); });

      $('#btnAddServicio').addEventListener('click', () => { $('#servicioContainer').appendChild(servicioBlock()); refreshPreview(); });
      $('#btnAddEleccion').addEventListener('click', () => { $('#eleccionesContainer').appendChild(eleccionBlock()); refreshPreview(); });

      $('#btnAddEquipo').addEventListener('click', () => { $('#equiposContainer').appendChild(equipoBlock()); refreshPreview(); });
      $('#btnAddReferente').addEventListener('click', () => { $('#referentesContainer').appendChild(referenteBlock()); refreshPreview(); });

      $('#btnAddControversia').addEventListener('click', () => {
        const chk = document.getElementById('chkSinControversias');
        if (chk?.checked) {
          showAlert('warning', 'Est√° activada la opci√≥n "No se detectaron controversias p√∫blicas". Desm√°rcala para agregar controversias.');
          return;
        }
        $('#controversiasContainer').appendChild(controversiaBlock());
        setControversiasUIState();
        refreshPreview();
      });
      $('#btnAddFamiliar').addEventListener('click', () => { $('#familiaresContainer').appendChild(familiarBlock()); refreshPreview(); });

      // live preview
      $('#personaForm').addEventListener('input', refreshPreview);
      $('#personaForm').addEventListener('change', refreshPreview);

      $('#btnReset').addEventListener('click', clearAll);

      function renderTemasInteresCheckboxes() {
        const cont = document.getElementById('temasInteresChecks');
        if (!cont) return;

        cont.innerHTML = '';

        (temasCatalog || []).forEach(t => {
          const id = Number(t.id_tema);
          const div = document.createElement('div');
          div.className = 'form-check';

          div.innerHTML = `
            <input class="form-check-input tema-interes-chk"
                  type="checkbox"
                  id="tema_${id}"
                  data-id="${id}">
            <label class="form-check-label" for="tema_${id}">
              ${t.nombre}
            </label>
          `;

          cont.appendChild(div);
        });

        // listeners
        cont.querySelectorAll('.tema-interes-chk').forEach(chk => {
          chk.addEventListener('change', () => {
            toggleTemaOtroUI();
            refreshPreview?.();
          });
        });

        toggleTemaOtroUI();
      }

      //otro ocultar partido politico:
      function togglePartidoOtroUI() {
        const sel = document.getElementById('selPartidoActual');
        const wrap = document.getElementById('partidoOtroWrap');
        const inp  = document.getElementById('partidoOtroTexto');
        if (!sel || !wrap || !inp) return;

        const id = Number(sel.value || 0);
        const p = (partidosCatalog || []).find(x => Number(x.id_partido) === id);

        const esOtro = (p?.nombre || '').toLowerCase() === 'otro' || (p?.siglas || '').toUpperCase() === 'OTRO';

        wrap.classList.toggle('d-none', !esOtro);
        inp.required = esOtro;

        if (!esOtro) {
          inp.value = '';
          inp.classList.remove('is-invalid');
        }
      }

      document.getElementById('selPartidoActual')?.addEventListener('change', () => {
        togglePartidoOtroUI();
        refreshPreview?.();
      });
      //btn dom editar y eliminar
      document.getElementById('btnSalirEdicion')?.addEventListener('click', () => {
        cancelEditing();
        showAlert('info', 'Edici√≥n cancelada');
      });

      document.getElementById('btnEliminarPersona')?.addEventListener('click', async () => {
        if (!editingId) return;
        await onDeletePersona(editingId);
      });

      // submit
      $('#personaForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        hideAlert();

        const payload = buildPayload();
        //validacion otro este marcado en temas
        const temaOtroSel = (payload.temas_interes || []).find(t => t.otro_texto !== undefined);
        if (temaOtroSel && !temaOtroSel.otro_texto) {
          document.getElementById('temaOtroTexto')?.classList.add('is-invalid');
          return showAlert('warning', 'Si seleccionas ‚ÄúOtro‚Äù, captura la descripci√≥n del tema.');
        }

          // ‚úÖ VALIDACI√ìN: eventos de movilizaci√≥n (evitar incompletos)
        for (const ev of (payload.capacidad_movilizacion_eventos || [])) {
          const incompleto = !ev.nombre_evento || !ev.fecha_evento || ev.asistencia == null;
          if (incompleto) {
            return showAlert('warning', 'En cada evento de movilizaci√≥n captura: Nombre, Fecha y Asistencia.');
          }
          if (Number(ev.asistencia) < 0) {
            return showAlert('warning', 'La asistencia no puede ser negativa.');
          }
        }

        // ‚úÖ Sin controversias p√∫blicas (mutuo excluyente)
        const chkSin = document.getElementById('chkSinControversias')?.checked ?? false;

        // Asegura que viaje en persona
        payload.persona.sin_controversias_publicas = chkSin;

        // Si est√° marcado, forzamos controversias vac√≠as
        if (chkSin) payload.controversias = [];

        // ============================
        // VALIDACION FORMACION ACADEMICA
        // ============================
        const fa0 = (payload.formacion_academica || [])[0];

        if (fa0 && (fa0.nivel === 'Educaci√≥n Superior' || fa0.nivel === 'Posgrado')) {
          if (!fa0.grado_obtenido || !fa0.institucion) {
            showAlert(
              'warning',
              'Para Educaci√≥n Superior o Posgrado captura el grado obtenido y la instituci√≥n.'
            );
            return; // ‚õî NO env√≠a al backend
          }
          if (fa0.titulado === null) {
            return showAlert('warning', 'Indica si la persona est√° titulada.');
          }
        }
        // ============================
        if (!payload.persona.nombre) return showAlert('warning', 'El nombre es obligatorio.');
        // Nota: si no tienes usuarios, deja creado_por null.

        const idPartido = payload.persona.id_partido_actual;
        if (idPartido) {
          const p = (partidosCatalog || []).find(x => Number(x.id_partido) === Number(idPartido));
          const esOtro = (p?.nombre || '').toLowerCase() === 'otro' || (p?.siglas || '').toUpperCase() === 'OTRO';

          if (esOtro && !payload.persona.partido_otro_texto) {
            document.getElementById('partidoOtroTexto')?.classList.add('is-invalid');
            return showAlert('warning', 'Si seleccionas ‚ÄúOtro‚Äù, captura el nombre del partido.');
          }
        }
        //validacion de datod duplicados
        // üîÅ Re-checar duplicados justo antes de guardar (con exclude_id en edici√≥n)
        if (typeof checkDuplicadoNow === "function") {
          await checkDuplicadoNow(editingId);  // <- implementamos abajo
        }
        const dup = window.__dupCheck || [];
        const hayBloqueante = dup.some(x =>
          ["curp","rfc","clave_elector"].includes(x.match_type)
        );

        if (hayBloqueante) {
          showAlert("danger", "No se puede guardar: se detect√≥ un duplicado (CURP/RFC/Clave de elector).");
          return;
        }
        const haySeccion = dup.some(x => x.match_type === "seccion_electoral");
        if (haySeccion) {
          showAlert("danger", "No se puede guardar: ya existe alguien con la misma Secci√≥n Electoral.");
          return;
        }
        try {
          const isEdit = !!editingId;

          const url = isEdit ? `/personas/${editingId}` : `/personas`;
          const resp = isEdit ? await apiPut(url, payload) : await apiPost(url, payload);

          // ‚úÖ Mensaje OK
          const idGuardado = isEdit ? editingId : resp.id_persona;
          showAlert('success', isEdit
            ? `Actualizado correctamente ‚úÖ id_persona: ${idGuardado}`
            : `Guardado correctamente ‚úÖ id_persona: ${idGuardado}`
          );

          // ‚úÖ Si ven√≠a de borrador, marcar como enviado
          if (borradorActualId) {
            try {
              await apiPut(`/borradores/${borradorActualId}`, { estatus: 'enviado' });
            } catch (_) {}
            setBorradorActual(null);
            await cargarListaBorradores();
          }

          // ‚úÖ Salir de edici√≥n despu√©s de actualizar (importante)
          if (isEdit) setEditing(null);

          clearAll();

          // (opcional) si tienes panel listado, refresca:
          // if (typeof recargarLista === 'function') recargarLista();

        } catch (err) {
          console.error(err);
          showAlert('danger', 'Error al guardar: ' + (err.message || err));
        }
      });
      
    } catch (e) {
      console.error(e);
      showAlert('danger', 'No pude cargar cat√°logos (municipios/redes/controversias). Revisa backend.');
    }
  })();
</script>

<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasPersonas">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Personas capturadas</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>

  <div class="offcanvas-body">
    <div class="input-group mb-2">
      <input class="form-control" id="txtBuscarPersona" placeholder="Buscar (nombre / CURP / RFC)">
      <button class="btn btn-outline-primary" id="btnBuscarPersona">Buscar</button>
    </div>

    <div class="small text-muted mb-2">Selecciona una persona para cargarla al formulario.</div>

    <div class="list-group" id="listaPersonas"></div>

    <hr class="my-3">

    <div class="d-flex gap-2">
      <button class="btn btn-warning w-100" id="btnSalirEdicion" disabled>Salir de edici√≥n</button>
      <button class="btn btn-danger w-100" id="btnEliminarPersona" disabled>Eliminar</button>
    </div>
  </div>
</div>

</body>
</html>
